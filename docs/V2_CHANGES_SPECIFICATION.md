# AIIMAGE V2 新旧页面变化对照文档

> **文档用途**: 详细记录V2版本与旧版的所有逻辑差异
> **创建时间**: 2025-11-14
> **维护者**: AI Assistant

---

## 📋 核心变化总览

| 模块 | 旧版逻辑 | V2新逻辑 | 影响范围 |
|------|---------|----------|---------|
| 生图模式 | 三个独立模式 | 智能合并模式 | 🔴 重大变化 |
| 输入位置 | 左侧面板 | 底部浮动输入框 | 🔴 重大变化 |
| 上传图片 | 最多9张 | 最多7张（1+6） | 🟡 中度变化 |
| 结果展示 | 4行内容 | 2行内容 | 🟡 中度变化 |
| 操作区域 | 固定显示 | 点击展开 | 🟢 轻度变化 |
| 侧边栏 | 固定 | 可折叠 | 🟢 轻度变化 |

---

## 一、生图操作逻辑变化

### 1.1 模式选择逻辑

#### 🔴 旧版逻辑
```
┌─────────────────────────────────────┐
│  [文生图] [图生图] [系列图]        │  ← 三个独立按钮
├─────────────────────────────────────┤
│  所有操作在左侧面板完成:            │
│  - 提示词输入框                     │
│  - 上传图片（图生图/系列图时显示）  │
│  - 尺寸选择器                       │
│  - 数量选择器                       │
│  - 生成按钮                         │
└─────────────────────────────────────┘
```

**旧版特点**:
- 用户必须先选择模式（文生图/图生图/系列图）
- 切换模式时界面会切换对应的表单
- 提示词输入框在左侧面板

---

#### 🔴 V2新逻辑（智能合并）
```
┌─────────────────────────────────────┐
│  左侧素材库（固定显示）:             │
│  - 上传图片区域（无图 = 文生图）    │
│  - 尺寸选择器                       │
│  - 数量选择器                       │
│  - 系列图开关（勾选 = 系列图）      │
├─────────────────────────────────────┤
│  底部提示词输入框（浮动）            │
│  - 用户在此输入提示词                │
│  - 点击生成按钮                      │
└─────────────────────────────────────┘

智能判断规则:
┌──────────────────────────────────────────┐
│ IF 没有上传图片:                         │
│    → 文生图模式                          │
│ ELSE IF 上传了图片 AND 系列图开关OFF:    │
│    → 图生图模式                          │
│ ELSE IF 上传了图片 AND 系列图开关ON:     │
│    → 系列图模式                          │
└──────────────────────────────────────────┘
```

**V2特点**:
- ✅ 无需手动选择模式，系统自动判断
- ✅ 素材库在左侧，提示词在底部
- ✅ 有图/无图 + 系列图开关 = 自动决定模式

---

### 1.2 界面布局变化

#### 🔴 旧版布局
```
┌────────────┬────────────────────────┐
│            │                        │
│  左侧面板  │     右侧结果区域       │
│            │                        │
│  - 模式    │     (历史记录卡片)     │
│  - 提示词  │                        │
│  - 图片    │                        │
│  - 尺寸    │                        │
│  - 数量    │                        │
│  - 生成    │                        │
│            │                        │
└────────────┴────────────────────────┘
```

---

#### 🔴 V2新布局
```
┌────────────┬────────────────────────┐
│            │   顶部导航栏           │
│  左侧素材库├────────────────────────┤
│  (可折叠)  │                        │
│            │   结果区域             │
│  - 上传    │   (历史记录卡片)       │
│  - 尺寸    │                        │
│  - 数量    │                        │
│  - 系列图  │                        │
│            ├────────────────────────┤
│            │  底部输入框(浮动)       │
│            │  [提示词输入框]  [生成]│
└────────────┴────────────────────────┘
```

**关键差异**:
1. 提示词从左侧移到底部浮动框
2. 左侧只保留"资料库"功能（上传、参数）
3. 底部输入框独立，始终可见

---

## 二、上传图片逻辑变化

### 2.1 数量限制

| 项目 | 旧版 | V2新版 |
|------|------|--------|
| 最大数量 | 9张 | 7张 |
| 初始状态 | 全部显示 | 1张大图 |
| 扩展方式 | 固定9个位置 | 点击+号动态增加 |

---

### 2.2 上传区域展示逻辑

#### 🔴 旧版逻辑
```
固定9个上传框，3x3网格排列
┌───┬───┬───┐
│ 1 │ 2 │ 3 │
├───┼───┼───┤
│ 4 │ 5 │ 6 │
├───┼───┼───┤
│ 7 │ 8 │ 9 │
└───┴───┴───┘
```

---

#### 🔴 V2新逻辑（动态扩展）

**初始状态（1张大图）**:
```
┌─────────────────┐
│                 │
│   主上传区域     │  ← 大图（正方形）
│   (点击上传)     │
│                 │
└─────────────────┘
        +  ← 点击+号增加上传位置
```

**点击1次+号后（增加2个位置，共3张）**:
```
┌─────────────────┐
│   主上传区域     │  ← 大图
└─────────────────┘
┌────────┬────────┐
│  Pic 1 │  Pic 2 │  ← 新增一行（2个小图）
└────────┴────────┘
        +
```

**点击2次+号后（增加4个位置，共5张）**:
```
┌─────────────────┐
│   主上传区域     │
└─────────────────┘
┌────────┬────────┐
│  Pic 1 │  Pic 2 │
├────────┼────────┤
│  Pic 3 │  Pic 4 │
└────────┴────────┘
        +
```

**点击3次+号后（增加6个位置，共7张 - 已达上限）**:
```
┌─────────────────┐
│   主上传区域     │
└─────────────────┘
┌────────┬────────┐
│  Pic 1 │  Pic 2 │
├────────┼────────┤
│  Pic 3 │  Pic 4 │
├────────┼────────┤
│  Pic 5 │  Pic 6 │
└────────┴────────┘
      (已达上限)
```

---

### 2.3 交互规则

| 操作 | 旧版 | V2新版 |
|------|------|--------|
| 初始显示 | 9个空框 | 1个大图框 |
| 增加位置 | 无需操作 | 点击+号，每次增加2个 |
| 最大次数 | - | 点击3次+号 |
| 超出提示 | 硬性弹窗 | 温和提示（Toast） |
| +号状态 | - | 达到上限后禁用并显示提示 |

---

### 2.4 代码实现要点

```javascript
// 当前实现（index.html:422-456）
let uploadRowCount = 0;
const maxUploadRows = 3;  // 最多3行（1+6=7张）

addUploadRowBtn.addEventListener('click', () => {
    if (uploadRowCount >= maxUploadRows) {
        // ❌ 旧版: alert('最多7张图片')
        // ✅ V2: 显示温和Toast提示
        showToast('最多可上传7张图片');
        return;
    }
    uploadRowCount++;
    // 动态添加一行（2个上传框）
    // ...
});
```

---

## 三、结果页面逻辑变化

### 3.1 任务卡片结构

#### 🔴 旧版结构（4行）
```
┌─────────────────────────────────────┐
│ 📅 2025-11-14 10:30  |  文生图  |  1:1  |  成功: 4/4  │ ← 第1行：状态栏
├─────────────────────────────────────┤
│ "一只可爱的橙色猫咪..."                │ ← 第2行：提示词
├─────────────────────────────────────┤
│ [图1] [图2] [图3] [图4]              │ ← 第3行：图片网格
├─────────────────────────────────────┤
│ [再次生成] [复制提示词] [删除]       │ ← 第4行：操作区域
└─────────────────────────────────────┘
```

---

#### 🔴 V2新结构（2行）
```
┌─────────────────────────────────────┐
│ "一只可爱的橙色猫咪..."         [...] │ ← 第1行：提示词 + 更多按钮
├─────────────────────────────────────┤
│ [图1] [图2] [图3] [图4]              │ ← 第2行：图片网格
└─────────────────────────────────────┘

点击 [...] 后展开操作菜单:
┌───────────────┐
│ 再次生成      │
│ 复制提示词    │
│ 删除任务      │
└───────────────┘
```

---

### 3.2 状态信息去向

| 信息 | 旧版位置 | V2新版位置 |
|------|---------|-----------|
| 时间 | 状态栏第一项 | 隐藏（或移到悬浮提示） |
| 模式 | 状态栏徽章 | 隐藏（或移到操作菜单） |
| 尺寸 | 状态栏徽章 | 隐藏（或移到操作菜单） |
| 成功状态 | 状态栏统计 | 隐藏（或移到操作菜单） |

**设计理念**:
- ✅ 简化视觉层级，突出内容
- ✅ 次要信息通过交互查看
- ✅ 更加现代、简洁

---

### 3.3 操作区域交互

#### 旧版: 固定显示
```
每个任务卡片底部固定显示操作按钮
优点: 直观
缺点: 占用空间，视觉干扰
```

#### V2新版: 点击展开
```
默认隐藏操作按钮
点击 [...] 展开下拉菜单
优点: 简洁，节省空间
缺点: 需要一次额外点击
```

---

## 四、点击图片后的新功能

### 4.1 功能对比

#### 🔴 旧版功能
```
点击图片 → 全屏查看
[关闭] [下载]
```

---

#### 🔴 V2新增功能
```
点击图片 → 全屏查看
┌────────────────────────────────┐
│  [收藏] [修改] [视频] [下载]   │
└────────────────────────────────┘
```

---

### 4.2 新功能详细说明

#### ✨ 功能1: 收藏
```
功能: 保存图片到个人收藏夹
流程:
  1. 用户点击 [收藏] 按钮
  2. 调用后端API: POST /api/v2/favorites
     参数: { task_id, image_index }
  3. 显示温和提示: "已添加到收藏夹"
  4. 按钮状态变为已收藏（图标填充）

数据存储:
  - 新表: favorites (user_id, task_id, image_index, created_at)
  - 或在现有表添加字段: tasks.favorited_images (JSON数组)
```

**注意**: 此功能需要新增后端API（不破坏现有API）

---

#### ✨ 功能2: 视频（预留）
```
功能: 图片转视频
状态: 暂时保留图标，功能后续实现
流程（未来）:
  1. 用户点击 [视频] 按钮
  2. 跳转到图转视频界面
  3. 传递当前图片作为素材

当前实现:
  - 显示图标
  - 点击后显示提示: "功能即将上线，敬请期待"
```

---

#### ✨ 功能3: 修改
```
功能: 使用当前图片作为素材重新生成
流程:
  1. 用户点击某张图片的 [修改] 按钮
  2. 界面变化:
     a. 提示词输入框显示当前图片缩略图
     b. 左侧素材库清空现有图片
     c. 替换为点击的这张图片
     d. 提示词框聚焦，等待用户输入新提示词
  3. 用户输入新提示词
  4. 点击生成，调用图生图API

界面示例:
┌─────────────────────────────────────┐
│  [📷当前图] 请输入修改提示词...      │ ← 提示词框显示图片预览
├─────────────────────────────────────┤
左侧素材库:
┌─────────────┐
│ 点击修改的图 │ ← 自动填充到素材库
└─────────────┘
```

**关键逻辑**:
- 提示词框显示小图标，提示当前正在修改的图片
- 素材库图片被替换（清空其他上传的图）
- 生成时自动使用图生图模式

---

#### ✨ 功能4: 下载
```
功能: 下载原图
流程:
  1. 用户点击 [下载] 按钮
  2. 如果当前是缩略图，先加载原图
  3. 使用 <a download> 触发下载
  4. 文件名: aiimage_{task_id}_{index}.jpg

代码示例:
const downloadImage = (imageUrl, filename) => {
    const a = document.createElement('a');
    a.href = imageUrl;
    a.download = filename;
    a.click();
};
```

---

### 4.3 图片查看器UI变化

#### 旧版
```
┌──────────────────────────────┐
│         [关闭 X]             │
│                              │
│       [图片显示]             │
│                              │
│         [下载]               │
└──────────────────────────────┘
```

#### V2新版
```
┌──────────────────────────────┐
│  [关闭 X]              [下载]│ ← 顶部工具栏
│                              │
│       [图片显示]             │
│                              │
│  [收藏] [修改] [视频]        │ ← 底部操作栏
└──────────────────────────────┘
```

---

## 五、素材区域折叠功能

### 5.1 折叠逻辑

#### 🔴 旧版
```
左侧面板固定宽度，无法折叠
```

#### 🔴 V2新版
```
支持折叠/展开，两种状态:

1. 展开状态（默认）:
   - 宽度: 340px
   - 显示: 完整内容（文字、表单、按钮）
   - 提示词框: max-w-4xl (居中，适中宽度)

2. 折叠状态:
   - 宽度: 80px
   - 显示: 仅图标（Logo、上传图标、尺寸图标、数量图标）
   - 提示词框: max-w-7xl (更宽，利用空间)
```

---

### 5.2 折叠交互方式

#### 方式1: 点击折叠按钮
```
┌────────────┐
│  素材库    │ ← 按钮在侧边栏右侧中间
│            │     位置: absolute top-1/2
│      [<]   │     图标: chevron_left (折叠)
│            │           chevron_right (展开)
│            │
└────────────┘
```

#### 方式2: 点击左侧空白区域
```
用户点击左侧素材库的任意空白处:
  - 当前展开 → 折叠
  - 当前折叠 → 展开

优点: 自然的交互体验
实现: 在 sidebar 元素上添加点击事件
注意: 需要阻止子元素冒泡（避免误触）
```

---

### 5.3 折叠后的显示内容

| 元素 | 展开状态 | 折叠状态 |
|------|---------|---------|
| Logo文字 | "基本粒子" | 隐藏 |
| Logo图标 | 5个圆点 | 5个圆点（居中） |
| 上传区域 | 大图框 | 单个图标 |
| 尺寸选择 | 完整下拉框 | 单个图标 |
| 数量选择 | 4个按钮 | 单个图标 |
| 系列图开关 | 完整开关 | 隐藏 |
| 底部区域 | 用户信息 | 隐藏 |

**折叠状态示例**:
```
┌──┐
│··│ ← Logo图标
│·.│
│  │
│📷│ ← 上传图标
│  │
│📐│ ← 尺寸图标
│  │
│4 │ ← 数量图标
│  │
└──┘
```

---

### 5.4 提示词框动态调整

```javascript
// 展开时
promptWrapper.classList.add('max-w-4xl');
promptWrapper.classList.remove('max-w-7xl');

// 折叠时
promptWrapper.classList.add('max-w-7xl');
promptWrapper.classList.remove('max-w-4xl');
```

**视觉效果**:
```
展开状态:
┌────────┬──────────────────────┐
│        │  [    提示词框    ]  │ ← 适中宽度
│ 素材库 │                      │
│        │                      │
└────────┴──────────────────────┘

折叠状态:
┌─┬─────────────────────────────┐
│ │  [      提示词框        ]   │ ← 更宽，利用空间
│ │                             │
│ │                             │
└─┴─────────────────────────────┘
```

---

## 六、提示方式优化

### 6.1 全局提示规范

#### ❌ 旧版: 硬性弹窗
```javascript
// 旧版代码
alert('余额不足');
confirm('确定删除吗？');
```

**问题**:
- 阻断用户操作
- 视觉突兀
- 用户体验差

---

#### ✅ V2新版: 温和Toast提示
```javascript
// 新版代码
showToast('余额不足，请充值后再试', 'warning');
showToast('删除成功', 'success');
showToast('最多可上传7张图片', 'info');
```

**优点**:
- 不阻断操作
- 自动消失（3-5秒）
- 友好、现代

---

### 6.2 Toast提示样式

```css
/* Toast 基础样式 */
.v2-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 24px;
    border-radius: 12px;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease-out;
    z-index: 9999;
}

.v2-toast.success { border-left: 4px solid #10b981; }
.v2-toast.warning { border-left: 4px solid #f59e0b; }
.v2-toast.error { border-left: 4px solid #ef4444; }
.v2-toast.info { border-left: 4px solid #3b82f6; }

@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
```

---

### 6.3 需要替换的提示场景

| 场景 | 旧版 | V2新版 |
|------|------|--------|
| 上传超出限制 | `alert('最多9张')` | `showToast('最多可上传7张图片', 'info')` |
| 余额不足 | `alert('粒子币不足')` | `showToast('粒子币余额不足', 'warning')` |
| 删除确认 | `confirm('确定删除?')` | 自定义确认对话框（优雅） |
| 生成成功 | 无提示 | `showToast('生成成功', 'success')` |
| 生成失败 | `alert('生成失败')` | `showToast('生成失败，请重试', 'error')` |
| 复制成功 | `alert('已复制')` | `showToast('提示词已复制', 'success')` |

---

## 七、后端集成说明

### 7.1 共享资源（不修改）

#### ✅ 完全共享，无需任何改动
```
1. 用户认证系统
   - localStorage.auth_token (共享)
   - POST /auth/token (登录)
   - POST /auth/register (注册)
   - GET /users/me (获取用户信息)

2. 粒子币系统
   - 扣费逻辑: 前端预扣
   - 计费规则: 1币/张（文生图、图生图），2币（系列图）
   - 退款逻辑: POST /api/refund-task

3. 图片生成API
   - POST /run/generate_image/google_gemini_image_rest (文生图)
   - POST /run/edit_image/google_gemini_image_rest (图生图)
   - POST /api/optimize-prompt (提示词优化)

4. 历史记录
   - GET /users/me/tasks?lite=1 (列表)
   - GET /users/me/tasks/{task_id} (详情)
   - DELETE /users/me/tasks/{task_id} (删除)

5. 数据库
   - users 表 (用户、粒子币)
   - tasks 表 (历史任务)
   - images 表 (图片数据)
```

---

### 7.2 需要新增的API（可选功能）

#### 🆕 收藏功能API
```javascript
// 添加收藏
POST /api/v2/favorites
Request Body:
{
    "task_id": "temp_1731564123456",
    "image_index": 0  // 第几张图片
}

Response:
{
    "success": true,
    "message": "已添加到收藏"
}

// 获取收藏列表
GET /api/v2/favorites

// 取消收藏
DELETE /api/v2/favorites/{favorite_id}
```

**数据库设计（可选）**:
```sql
CREATE TABLE favorites (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    task_id TEXT NOT NULL,
    image_index INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

### 7.3 前端调用模式判断逻辑

```javascript
// V2新版: 智能判断生成模式
function getGenerationMode() {
    const hasImages = uploadedImages.length > 0;
    const seriesMode = seriesToggle.getAttribute('aria-checked') === 'true';

    if (!hasImages) {
        return 'text-to-image';  // 无图 = 文生图
    } else if (seriesMode) {
        return 'conversation';    // 有图 + 系列图开关 = 系列图
    } else {
        return 'image-to-image';  // 有图 = 图生图
    }
}

// 调用对应的API
const mode = getGenerationMode();
if (mode === 'text-to-image') {
    await generateTextToImage(prompt, aspectRatio, count);
} else if (mode === 'image-to-image') {
    await generateImageToImage(prompt, uploadedImages, aspectRatio, count);
} else if (mode === 'conversation') {
    await generateConversation(prompt, uploadedImages);
}
```

---

## 八、开发优先级

### 🔴 阶段1: 前端框架完善（当前）
**目标**: 完成所有交互效果，不接入后端

- [x] HTML结构已完成
- [ ] 上传图片预览功能
- [ ] 图片删除功能
- [ ] 折叠空白区域点击
- [ ] Toast提示系统
- [ ] 图片查看器（含新功能图标）
- [ ] 操作菜单展开/收起
- [ ] 移动端适配（可选）

**验收标准**:
- 所有交互流畅
- 无JavaScript错误
- 样式完美呈现

---

### 🟡 阶段2: 后端API接入
**目标**: 对接所有共享API

- [ ] 登录/注册功能
- [ ] 粒子币显示和扣费
- [ ] 文生图功能
- [ ] 图生图功能
- [ ] 系列图功能
- [ ] 历史记录加载
- [ ] 图片懒加载
- [ ] 再次生成功能
- [ ] 删除任务功能

**验收标准**:
- 数据与旧版同步
- 粒子币扣费正确
- 无重复扣费

---

### 🟢 阶段3: 新功能开发
**目标**: 实现V2独有功能

- [ ] 收藏功能（需要新API）
- [ ] 修改图片功能
- [ ] 视频功能（预留图标）
- [ ] 收藏夹页面

---

## 九、注意事项

### ⚠️ 关键原则

1. **不破坏旧版**
   - 不修改现有API
   - 不修改数据库结构（只增不改）
   - 不修改共享的JS工具函数

2. **CSS作用域隔离**
   - V2使用 `.v2-` 前缀
   - 使用 Tailwind CSS（已引入）
   - 避免全局样式污染

3. **数据共享**
   - Token使用相同key: `auth_token`
   - 调用相同的后端API
   - 共享数据库表

4. **温和提示**
   - 全局禁用 `alert()`, `confirm()`
   - 使用Toast提示系统
   - 友好的用户体验

---

## 十、快速参考

### 文件路径
```
/root/AIIMAGE/frontend/v2/
├── index.html          # 主页面（已完成）
├── css/
│   └── main.css       # 样式文件（待完善）
├── js/
│   ├── app.js         # 主入口（待实现）
│   ├── modules/       # 功能模块
│   │   ├── UIManager.js
│   │   ├── ImageGenerator.js
│   │   └── HistoryManager.js
│   └── utils/         # 工具函数
│       ├── api.js
│       ├── toast.js   # Toast提示系统
│       └── helpers.js
└── docs/
    └── V2_CHANGES_SPECIFICATION.md  # 本文档
```

---

### 关键数据结构

```javascript
// 上传的图片数组
uploadedImages = [
    { file: File, dataUrl: 'data:image/...' },
    { file: File, dataUrl: 'data:image/...' }
];

// 生成参数
const params = {
    prompt: string,
    aspectRatio: '1:1' | '16:9' | '9:16' | '3:4' | '4:3',
    count: 1 | 2 | 3 | 4,
    seriesMode: boolean,
    uploadedImages: File[]
};

// 任务数据（后端返回）
const task = {
    task_id: 'temp_xxx',
    mode: 'text-to-image' | 'image-to-image' | 'conversation',
    prompt: string,
    aspect_ratio: string,
    image_count: number,
    status: 'pending' | 'processing' | 'completed' | 'partial' | 'failed',
    generated_images: [{ url, thumbnail_url }],
    reference_images: [base64]
};
```

---

## 十一、测试清单

### 前端交互测试
- [ ] 上传图片：点击主上传区域
- [ ] 上传图片：点击+号增加位置
- [ ] 上传图片：上传7张后禁用+号
- [ ] 上传图片：超出7张显示Toast
- [ ] 上传图片：预览图片缩略图
- [ ] 上传图片：删除已上传的图片
- [ ] 尺寸选择：点击展开下拉菜单
- [ ] 尺寸选择：选择后更新显示
- [ ] 尺寸选择：折叠时点击图标展开侧边栏
- [ ] 数量选择：点击切换选中状态
- [ ] 系列图开关：点击切换状态
- [ ] 侧边栏折叠：点击按钮折叠/展开
- [ ] 侧边栏折叠：点击空白区域折叠/展开
- [ ] 侧边栏折叠：提示词框自动调整宽度
- [ ] 提示词输入：输入文字
- [ ] 提示词输入：点击生成按钮
- [ ] 结果展示：显示占位符
- [ ] 结果展示：显示生成的图片
- [ ] 结果展示：点击...展开操作菜单
- [ ] 图片查看器：点击图片打开查看器
- [ ] 图片查看器：显示4个操作按钮
- [ ] 图片查看器：点击关闭

### 后端集成测试
- [ ] 登录功能
- [ ] 注册功能
- [ ] 粒子币显示
- [ ] 文生图生成
- [ ] 图生图生成
- [ ] 系列图生成
- [ ] 历史记录加载
- [ ] 删除任务
- [ ] 再次生成
- [ ] 粒子币扣费正确
- [ ] 数据与旧版同步

---

**文档版本**: 1.0
**最后更新**: 2025-11-14
**维护者**: AI Assistant
