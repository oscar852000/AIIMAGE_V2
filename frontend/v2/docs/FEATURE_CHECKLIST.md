# AIIMAGE 新前端接入功能清单

> **用途**: 新前端开发时的功能对照清单
> **使用方式**: 逐条核对，确保所有功能都已实现

---

## 📋 核心功能模块

### ✅ 1. 认证系统 (Authentication)

#### 1.1 用户登录

- [ ] **登录表单**
  - [ ] 用户名输入框
  - [ ] 密码输入框
  - [ ] 登录按钮
  - [ ] 提交时禁用按钮，显示Loading
  - [ ] 表单验证（非空检查）

- [ ] **API调用**
  - [ ] `POST /auth/token` (URLEncoded格式)
  - [ ] 错误处理（401显示"用户名或密码错误"）
  - [ ] Token保存到 localStorage

- [ ] **登录成功后**
  - [ ] 关闭登录模态框
  - [ ] 获取用户信息 `GET /users/me`
  - [ ] 更新UI为登录状态
  - [ ] 触发 `auth:ready` 事件
  - [ ] 加载历史记录

**参考代码**: `frontend/gemini_image_modern.html:579-620`

---

#### 1.2 用户注册

- [ ] **注册表单**
  - [ ] 用户名输入框
  - [ ] 密码输入框
  - [ ] 邮箱输入框（可选）
  - [ ] 注册按钮
  - [ ] 提交时禁用按钮，显示Loading

- [ ] **API调用**
  - [ ] `POST /auth/register` (JSON格式)
  - [ ] 错误处理（400显示"用户名已存在"）
  - [ ] 成功后自动登录

**参考代码**: `frontend/gemini_image_modern.html:624-669`

---

#### 1.3 登录状态管理

- [ ] **页面加载时**
  - [ ] 检查 localStorage 中是否有 token
  - [ ] 有token → 调用 `/users/me` 验证
  - [ ] 无token → 显示访客状态

- [ ] **登出功能**
  - [ ] 清除 localStorage token
  - [ ] 重置用户信息
  - [ ] 更新UI为访客状态
  - [ ] 触发 `auth:logout` 事件
  - [ ] 清空历史记录

- [ ] **UI状态切换**
  - [ ] 未登录: 显示登录按钮
  - [ ] 已登录: 显示粒子币徽章 + 用户菜单

**参考代码**: `frontend/gemini_image_modern.html:463-820`

---

### ✅ 2. 粒子币系统 (Particles)

#### 2.1 余额显示

- [ ] **顶部导航栏**
  - [ ] 粒子币徽章（金色背景）
  - [ ] 显示当前余额数字
  - [ ] 未登录时隐藏

- [ ] **实时更新**
  - [ ] 登录后立即显示
  - [ ] 生成完成后自动刷新
  - [ ] 调用 `GET /users/me` 获取最新余额

**参考代码**: `UIManager.js:172-186`

---

#### 2.2 扣费计算

- [ ] **计费规则**
  - [ ] 文生图: 1币/张 × 数量
  - [ ] 图生图: 1币/张 × 数量
  - [ ] 系列图: 固定2币

- [ ] **生成按钮成本提示**
  - [ ] 显示 `(消耗 N 粒子币)`
  - [ ] 根据模式和数量动态更新

**参考代码**: `UIManager.js:172-186`

---

#### 2.3 余额检查

- [ ] **生成前检查**
  - [ ] 计算所需粒子币
  - [ ] 对比当前余额
  - [ ] 余额不足 → 显示温和提示，不发送请求
  - [ ] 余额充足 → 继续生成流程

- [ ] **温和提示**
  - [ ] 非弹窗形式
  - [ ] 显示当前余额和所需金额
  - [ ] 自动消失（5-7秒）

**参考代码**: `UIManager.js:443-468`

---

### ✅ 3. 图片生成 (Image Generation)

#### 3.1 模式切换

- [ ] **三种模式**
  - [ ] 文生图 (text-to-image)
  - [ ] 图生图 (image-to-image)
  - [ ] 系列图 (conversation)

- [ ] **UI切换**
  - [ ] 点击模式按钮
  - [ ] 切换按钮激活状态 (active class)
  - [ ] 显示/隐藏对应的表单区域
  - [ ] 更新生成按钮成本提示

**参考代码**: `UIManager.js:148-170`

---

#### 3.2 文生图功能

##### 表单元素

- [ ] **提示词输入**
  - [ ] 多行文本框 (textarea)
  - [ ] 占位符文字
  - [ ] 非空验证

- [ ] **画面比例选择器**
  - [ ] 5个选项: 1:1, 16:9, 9:16, 4:3, 3:4
  - [ ] 单选，默认1:1
  - [ ] 按钮式UI (active高亮)

- [ ] **生成数量选择器**
  - [ ] 4个选项: 1, 2, 3, 4
  - [ ] 单选，默认4
  - [ ] 数字按钮UI

- [ ] **提示词优化按钮**
  - [ ] 点击调用 `POST /api/optimize-prompt`
  - [ ] 禁用状态，显示"优化中..."
  - [ ] 成功后替换提示词内容

##### 生成流程

- [ ] **参数收集**
  - [ ] prompt: string
  - [ ] aspectRatio: string
  - [ ] count: number

- [ ] **API调用**
  - [ ] 并发生成单张图片（for循环 + Promise.all）
  - [ ] 每张图片独立调用 `POST /run/generate_image/{adapter_id}`
  - [ ] 添加不可见空格避免缓存: `prompt + '\u200B'.repeat(i)`

- [ ] **实时显示**
  - [ ] 创建pending状态的任务卡片
  - [ ] 每完成一张立即更新卡片
  - [ ] 显示进度 "生成中 (2/4)"

- [ ] **失败处理**
  - [ ] 自动重试失败的图片（仅一次）
  - [ ] 计算成功和失败数量
  - [ ] 调用退款接口 `POST /api/refund-task`

- [ ] **最终状态**
  - [ ] 全部成功 → status: 'completed'
  - [ ] 部分成功 → status: 'partial'
  - [ ] 全部失败 → 删除任务卡片，显示错误提示

**参考代码**: `ImageGenerator.js:96-215`

---

#### 3.3 图生图功能

##### 表单元素

- [ ] **图片上传区域**
  - [ ] 点击上传
  - [ ] 拖拽上传
  - [ ] 支持多张图片（最多9张）
  - [ ] 图片预览卡片
  - [ ] 删除按钮（每张图片）

- [ ] **文件验证**
  - [ ] 类型检查 (image/png, image/jpeg, image/webp)
  - [ ] 大小限制
  - [ ] 数量限制（最多9张）

- [ ] **提示词输入**（同文生图）

- [ ] **画面比例选择器**（同文生图）

- [ ] **生成数量选择器**（同文生图）

##### 生成流程

- [ ] **File副本机制**
  - [ ] 预创建每个请求的File副本
  - [ ] 避免并发时读取同一File对象导致数据损坏

- [ ] **FormData构建**
  - [ ] formData.append('prompt', prompt)
  - [ ] formData.append('task_id', taskId)
  - [ ] formData.append('image', filesCopy)  // 每张参考图
  - [ ] formData.append('total_image_count', count)
  - [ ] formData.append('model_params', JSON.stringify({...}))

- [ ] **并发策略**
  - [ ] count ≤ 2: 全并发
  - [ ] count > 2: 先2张，等6秒，再并发剩余

- [ ] **进度显示**
  - [ ] 每个slot显示状态徽章
  - [ ] 状态: 排队中 → 上传中 → 完成/失败
  - [ ] 实时更新卡片图片

**参考代码**: `ImageGenerator.js:217-424`

---

#### 3.4 系列图功能

##### 表单元素

- [ ] **提示词输入**（可选）

- [ ] **图片上传区域**（可选）
  - [ ] 支持多张参考图
  - [ ] 预览和删除

##### 生成流程

- [ ] **判断有无参考图**
  - [ ] 有图片 → `POST /run/edit_image/{adapter_id}` (FormData)
  - [ ] 无图片 → `POST /run/generate_image/{adapter_id}` (JSON)

- [ ] **model_params配置**
  ```javascript
  {
    response_modalities: ['Text', 'Image'],
    mode: 'conversation'
  }
  ```

- [ ] **返回数据处理**
  - [ ] 删除 `description` 字段
  - [ ] 图片数量可变（1-4张）
  - [ ] 更新任务卡片的 `data-image-count`

- [ ] **粒子币**
  - [ ] 固定扣2币
  - [ ] 不退款

**参考代码**: `ImageGenerator.js:15-94`

---

### ✅ 4. 历史记录 (History)

#### 4.1 列表加载

- [ ] **页面加载时**
  - [ ] 检查登录状态
  - [ ] 未登录 → 显示访客空状态
  - [ ] 已登录 → 显示骨架屏 + 加载历史

- [ ] **Lite模式加载**
  - [ ] `GET /users/me/tasks?limit=8&lite=1`
  - [ ] 只包含元数据，不含图片
  - [ ] 渲染任务卡片（显示占位符）

- [ ] **本地缓存**
  - [ ] 保存到 localStorage
  - [ ] TTL: 5分钟
  - [ ] 再次访问时优先使用缓存

**参考代码**: `HistoryManager.js:161-209`

---

#### 4.2 任务卡片

##### 卡片结构

- [ ] **头部信息**
  - [ ] 创建时间 (MM/DD HH:mm)
  - [ ] 模式徽章 (文生图/图生图/系列图)
  - [ ] 画面比例徽章 (1:1, 16:9...)
  - [ ] 状态统计 (成功: 4/4)

- [ ] **提示词**
  - [ ] 显示用户原始提示词
  - [ ] 过长时截断，显示省略号

- [ ] **图片网格**
  - [ ] 2列布局 (移动端)
  - [ ] 4列布局 (PC端)
  - [ ] 16:9比例独占一行
  - [ ] 点击查看大图

- [ ] **操作按钮**
  - [ ] 再次生成
  - [ ] 复制提示词
  - [ ] 删除任务

**参考代码**: `HistoryManager.js:1261-1326`

---

#### 4.3 图片懒加载

- [ ] **Intersection Observer**
  - [ ] 监听任务卡片进入视口
  - [ ] 提前100px触发加载

- [ ] **加载策略**
  - [ ] 首次: 加载1张预览图 `max_images=1`
  - [ ] 800ms后: 加载剩余图片
  - [ ] 优先级队列: high优先级插队

- [ ] **渐进式渲染**
  - [ ] 逐张延迟加载（0ms, 150ms, 300ms...）
  - [ ] 淡入动画 (opacity 0→1)

**参考代码**: `HistoryManager.js:87-133, 737-802`

---

#### 4.4 再次生成

- [ ] **功能触发**
  - [ ] 点击"再次生成"按钮
  - [ ] 禁用按钮，显示"处理中..."

- [ ] **余额检查**
  - [ ] 计算所需粒子币
  - [ ] 检查余额是否充足

- [ ] **加载完整数据**
  - [ ] 如果是图生图/系列图，检查是否有 `reference_images`
  - [ ] 无参考图 → `GET /users/me/tasks/{task_id}?full=1`
  - [ ] 加载参考图为File对象

- [ ] **调用生成函数**
  - [ ] conversation + 有图 → `generateConversation(prompt, uploadedImages)`
  - [ ] conversation + 无图 → `generateConversation(prompt, [])`
  - [ ] text-to-image → `generateTextToImage(prompt, aspectRatio, count)`
  - [ ] image-to-image → `generateImageToImage(prompt, uploadedImages, aspectRatio, count)`

**参考代码**: `HistoryManager.js:1357-1491`

---

#### 4.5 删除任务

- [ ] **确认对话框**
  - [ ] `confirm('确定删除此记录吗?')`

- [ ] **API调用**
  - [ ] `DELETE /users/me/tasks/{task_id}`

- [ ] **前端清理**
  - [ ] 移除DOM元素 (淡出动画)
  - [ ] 清理缓存数据
  - [ ] 取消Intersection Observer监听

- [ ] **空状态检查**
  - [ ] 删除后无剩余卡片 → 显示空状态页面

**参考代码**: `HistoryManager.js:1541-1570`

---

#### 4.6 空状态页面

- [ ] **未登录状态**
  - [ ] 功能介绍文字
  - [ ] "立即登录"按钮
  - [ ] 新用户福利提示

- [ ] **已登录无历史**
  - [ ] 快速上手指南
  - [ ] 左箭头引导动画
  - [ ] 粒子漂浮背景动画

- [ ] **状态切换**
  - [ ] 监听 `auth:ready` 事件 → 切换到已登录版本
  - [ ] 监听 `auth:logout` 事件 → 切换回访客版本

**参考代码**: `HistoryManager.js:68-85`

---

### ✅ 5. UI交互细节

#### 5.1 移动端适配

- [ ] **模式切换器**
  - [ ] 纯文字+下划线tab设计
  - [ ] 移除触控高亮白线
  - [ ] 统一舞台高度 (280px)

- [ ] **上传区域**
  - [ ] 空状态 (is-empty): 显示完整上传按钮
  - [ ] 有图片: 收缩为窄条，只显示计数器

- [ ] **输入框**
  - [ ] 字体 ≥ 16px (防止iOS自动放大)
  - [ ] 统一蓝色边框

- [ ] **顶部导航**
  - [ ] 粒子币: 半透明金色背景
  - [ ] 用户菜单: 半透明蓝色背景
  - [ ] 点击缩放反馈

- [ ] **选择器面板**
  - [ ] 画面比例选择面板（底部弹出）
  - [ ] 生成数量选择面板
  - [ ] 遮罩层点击关闭

**参考代码**: `responsive.css`, `UIManager.js:578-801`

---

#### 5.2 PC端优化

- [ ] **顶部导航**
  - [ ] 蓝色渐变底边
  - [ ] 无硬边框

- [ ] **发光边框**
  - [ ] 左侧蓝色发光
  - [ ] 右侧金色发光
  - [ ] hover增强效果

- [ ] **滚动条隐藏**
  - [ ] 保留滚动功能
  - [ ] 隐藏滚动条UI

**参考代码**: `header.css`, `layout.css`

---

#### 5.3 按钮状态

- [ ] **生成按钮**
  - [ ] 正常: 可点击 + 显示粒子币消耗
  - [ ] 生成中: disabled + "生成中..."
  - [ ] 余额不足: 可点击（点击显示提示）

- [ ] **再次生成按钮**
  - [ ] 正常: "再次生成"
  - [ ] 处理中: disabled + "处理中..."

- [ ] **优化按钮**
  - [ ] 正常: "强化关键词"
  - [ ] 优化中: disabled + "优化中..."

**参考代码**: `UIManager.js:429-576`

---

#### 5.4 图片查看器

- [ ] **点击图片打开查看器**
  - [ ] 全屏遮罩层
  - [ ] 居中显示大图
  - [ ] 加载原图（如果当前是缩略图）

- [ ] **操作按钮**
  - [ ] 关闭按钮 (X)
  - [ ] 下载按钮

- [ ] **移动端**
  - [ ] 加载遮罩
  - [ ] 底部工具栏

**参考代码**: `dom.js`, `HistoryManager.js:1160-1259`

---

### ✅ 6. 数据流和状态管理

#### 6.1 Token管理

- [ ] **存储**
  - [ ] localStorage.setItem('auth_token', token)

- [ ] **读取**
  - [ ] 所有API请求时读取
  - [ ] 封装成工具函数 `getAuthToken()`

- [ ] **清除**
  - [ ] 登出时清除
  - [ ] 401错误时清除（Token失效）

**参考代码**: `api.js:10-12`

---

#### 6.2 用户状态

- [ ] **全局变量**
  - [ ] `window.authManager`
  - [ ] `authManager.user` (用户信息对象)
  - [ ] `authManager.token` (JWT Token)

- [ ] **事件通信**
  - [ ] `auth:ready` - 登录成功
  - [ ] `auth:logout` - 登出

**参考代码**: `gemini_image_modern.html:463-820`

---

#### 6.3 历史记录缓存

- [ ] **内存缓存**
  - [ ] `this.taskImages = new Map()` (任务图片缓存)
  - [ ] `this.latestTasks = []` (最新任务列表)

- [ ] **localStorage缓存**
  - [ ] 键名: `history_cache`
  - [ ] TTL: 5分钟
  - [ ] 格式: `{ timestamp, tasks }`

- [ ] **缓存更新**
  - [ ] 新任务完成时插入缓存首位
  - [ ] 删除任务时移除缓存
  - [ ] 登出时清空缓存

**参考代码**: `HistoryManager.js:135-159, 529-556`

---

#### 6.4 图片加载队列

- [ ] **优先级队列**
  - [ ] `this.fetchQueue = []`
  - [ ] 每项: `{ taskId, priority, requestOptions }`

- [ ] **并发控制**
  - [ ] `maxConcurrentFetches = 2`
  - [ ] `currentFetches = 0`

- [ ] **Promise管理**
  - [ ] `this.taskImagePromises = new Map()`
  - [ ] 避免重复请求同一任务

**参考代码**: `HistoryManager.js:407-511`

---

### ✅ 7. 错误处理

#### 7.1 API错误

- [ ] **401 未认证**
  - [ ] 清除Token
  - [ ] 跳转到登录页面
  - [ ] 提示"请重新登录"

- [ ] **402 粒子币不足**
  - [ ] 显示温和提示
  - [ ] 不发送请求

- [ ] **404 资源不存在**
  - [ ] 显示"任务不存在"
  - [ ] 从列表中移除

- [ ] **500 服务器错误**
  - [ ] 显示友好错误信息
  - [ ] 提供重试选项（如果适用）

**参考代码**: `api.js:30-40, 58-68`

---

#### 7.2 网络错误

- [ ] **fetch失败**
  - [ ] try-catch捕获
  - [ ] 显示"网络异常，请稍后重试"

- [ ] **超时处理**
  - [ ] 长时间无响应提示
  - [ ] 提供取消选项

**参考代码**: `ImageGenerator.js:100-215`

---

#### 7.3 用户输入验证

- [ ] **提示词验证**
  - [ ] 非空检查
  - [ ] 最大长度限制（可选）

- [ ] **图片验证**
  - [ ] 类型检查
  - [ ] 大小限制
  - [ ] 数量限制

- [ ] **登录表单验证**
  - [ ] 用户名非空
  - [ ] 密码非空

**参考代码**: `UIManager.js:429-512`

---

### ✅ 8. 性能优化

#### 8.1 图片优化

- [ ] **缩略图**
  - [ ] 默认加载缩略图（600x600, 95% quality）
  - [ ] 点击查看时加载原图

- [ ] **懒加载**
  - [ ] Intersection Observer
  - [ ] 提前100px触发

- [ ] **渐进式渲染**
  - [ ] 逐张延迟加载
  - [ ] 淡入动画

**参考代码**: `HistoryManager.js:737-802`

---

#### 8.2 请求优化

- [ ] **并发控制**
  - [ ] 图片加载最多2个并发
  - [ ] 图生图分批策略 (2+6s+剩余)

- [ ] **缓存策略**
  - [ ] localStorage缓存 (5分钟TTL)
  - [ ] 内存缓存 (Map对象)

- [ ] **去重机制**
  - [ ] 同一任务ID只扣费一次
  - [ ] 避免重复加载同一任务

**参考代码**: `HistoryManager.js:407-436`, `ImageGenerator.js:362-387`

---

#### 8.3 动画性能

- [ ] **CSS动画优先**
  - [ ] 使用 transform 和 opacity
  - [ ] 避免 width/height 动画

- [ ] **淡入淡出**
  - [ ] transition: opacity 0.3s

- [ ] **骨架屏**
  - [ ] 加载时显示占位符
  - [ ] 避免布局跳动

**参考代码**: `layout.css`, `task-card.css`

---

## 🎯 开发建议

### 阶段1: 基础功能（1-2天）

1. ✅ 认证系统
   - 登录/注册表单
   - Token管理
   - 用户状态切换

2. ✅ 基础UI
   - 顶部导航
   - 模式切换器
   - 表单布局

3. ✅ 文生图功能
   - 最简单的流程
   - 先实现单张生成
   - 验证API调用正确

### 阶段2: 完整生成（2-3天）

4. ✅ 并发生成
   - 实时流式显示
   - 失败重试
   - 退款处理

5. ✅ 图生图功能
   - 图片上传
   - File副本机制
   - 分批并发

6. ✅ 系列图功能
   - 两种调用方式
   - 数据处理

### 阶段3: 历史记录（2-3天）

7. ✅ 列表加载
   - Lite模式
   - 本地缓存
   - 骨架屏

8. ✅ 懒加载
   - Intersection Observer
   - 渐进式渲染
   - 优先级队列

9. ✅ 再次生成
   - 加载完整数据
   - 参考图处理

### 阶段4: 优化和细节（2-3天）

10. ✅ 移动端适配
    - 响应式布局
    - 触控优化
    - 面板交互

11. ✅ 错误处理
    - 友好提示
    - 重试机制

12. ✅ 性能优化
    - 缓存策略
    - 并发控制

---

## 📊 功能完成度追踪

### 核心功能

| 功能模块 | 子功能数 | 完成数 | 完成率 |
|---------|---------|--------|--------|
| 认证系统 | 12 | 0 | 0% |
| 粒子币系统 | 8 | 0 | 0% |
| 图片生成 | 45 | 0 | 0% |
| 历史记录 | 32 | 0 | 0% |
| UI交互 | 28 | 0 | 0% |
| 数据管理 | 15 | 0 | 0% |
| 错误处理 | 12 | 0 | 0% |
| 性能优化 | 10 | 0 | 0% |
| **总计** | **162** | **0** | **0%** |

---

## 🔗 参考资料

1. **API规格说明**: `docs/API_SPECIFICATION.md`
2. **前端逻辑分析**: Task Agent的详细报告
3. **当前实现代码**:
   - HTML: `/root/AIIMAGE/frontend/gemini_image_modern.html`
   - JS模块: `/root/AIIMAGE/frontend/static/js/modules/`
   - CSS: `/root/AIIMAGE/frontend/static/css/`
4. **后端代码**:
   - 路由: `/root/AIIMAGE/backend/routers/`
   - 数据库: `/root/AIIMAGE/backend/core/user_db.py`

---

**使用提示**:

1. 逐条核对清单，确保每个功能都已实现
2. 参考 `API_SPECIFICATION.md` 了解接口详情
3. 参考当前代码了解实现细节
4. 遇到问题时对照清单查漏补缺

**维护者**: AI Assistant
**创建时间**: 2025-11-14
**用途**: 新前端开发指南
