# AIIMAGE Web PC 新版开发项目 (V2)

## 📌 项目概述

**目标**: 为 AIIMAGE 平台开发全新的 PC 端用户界面（V2版本）

**核心原则**:
- ✅ 新版与旧版完全独立，互不干扰
- ✅ 共享后端数据（会员、积分、历史记录）
- ✅ 旧版功能保持100%可用
- ✅ 逐步迁移，平滑过渡

---

## 🎯 项目目标

### 功能目标
1. 全新的 UI/UX 设计（更现代、更高效）
2. 优化的交互逻辑（不同于旧版的用户体验）
3. 保持核心功能（文生图、图生图、系列图）
4. 完整的认证和历史记录系统

### 技术目标
1. 前后端完全解耦（RESTful API）
2. 模块化的 JS 架构（易维护、可扩展）
3. 响应式设计（PC 端优先）
4. 性能优化（懒加载、缓存策略）

---

## 📂 项目结构

### 新版位置
- **路径**: `/root/AIIMAGE/frontend/v2/`
- **访问**: `https://img.jibenlizi.net/v2/` （或独立域名）

### 文件组织
```
frontend/v2/
├── index.html              # 主页面
├── css/                    # 样式文件
│   ├── main.css           # 主样式文件
│   └── components/        # 组件样式
│       ├── header.css
│       ├── form.css
│       └── card.css
├── js/                     # 脚本文件
│   ├── app.js             # 主入口
│   ├── modules/           # 功能模块
│   │   ├── AuthManager.js
│   │   ├── ImageGenerator.js
│   │   └── HistoryManager.js
│   └── utils/             # 工具函数
│       ├── api.js
│       └── helpers.js
├── assets/                 # 静态资源（图标、图片）
└── docs/                   # 项目文档
    ├── PROJECT_PLAN.md     # 本文档
    ├── API_SPECIFICATION.md
    ├── FEATURE_CHECKLIST.md
    └── DEVELOPMENT_LOG.md
```

---

## 🚀 执行计划

### 阶段 1: 前端框架搭建（1-2天）

**目标**: 搭建完整的静态页面框架

**交付物**:
- [x] 创建项目目录结构
- [x] 备份现有代码
- [ ] 上线用户提供的 HTML 代码
- [ ] 完成基础 CSS 样式
- [ ] 实现核心交互效果（无后端调用）

**验收标准**:
- 页面可正常访问
- UI 符合设计预期
- 基础交互流畅（按钮、表单、动画）
- 无 JavaScript 错误

---

### 阶段 2: 后端接口接入（2-3天）

**目标**: 对接所有后端 API，实现完整功能

**依据文档**:
- `docs/API_SPECIFICATION.md` - API 调用规范
- `docs/FEATURE_CHECKLIST.md` - 功能核对清单（162项）

**核心功能**:

#### 2.1 认证系统
- [ ] 登录功能（POST /auth/token）
- [ ] 注册功能（POST /auth/register）
- [ ] Token 管理（localStorage 共享）
- [ ] 登录状态检测

#### 2.2 粒子币系统
- [ ] 余额显示（GET /users/me）
- [ ] 扣费计算（前端预扣）
- [ ] 余额检查（温和提示）
- [ ] 实时刷新

#### 2.3 图片生成
- [ ] 文生图（POST /run/generate_image）
- [ ] 图生图（POST /run/edit_image）
- [ ] 系列图（两种接口）
- [ ] 提示词优化（POST /api/optimize-prompt）
- [ ] 失败重试机制
- [ ] 退款处理（POST /api/refund-task）

#### 2.4 历史记录
- [ ] Lite 模式加载（GET /users/me/tasks?lite=1）
- [ ] 任务详情加载（GET /users/me/tasks/{id}）
- [ ] 懒加载图片（Intersection Observer）
- [ ] 再次生成功能
- [ ] 删除任务（DELETE /users/me/tasks/{id}）

**验收标准**:
- 所有 API 调用正常
- 数据与旧版共享（同一数据库）
- 粒子币扣费逻辑正确
- 无重复扣费问题

---

### 阶段 3: 样式细节优化（1-2天）

**目标**: 完善用户体验细节

**内容**:
- [ ] 调整实际使用中的样式问题
- [ ] 优化移动端适配（如需要）
- [ ] 完善错误提示和加载状态
- [ ] 性能优化（图片懒加载、缓存）
- [ ] 添加动画效果
- [ ] 优化按钮状态反馈

**验收标准**:
- 样式无明显问题
- 交互体验流畅
- 错误处理友好
- 加载状态明确

---

### 阶段 4: 新功能开发（按需）

**触发条件**:
- 新版有不同于旧版的功能需求
- 需要新增后端 API

**开发原则**:
- ✅ 新增接口独立开发，不修改现有接口
- ✅ 使用新的路由路径（如 `/api/v2/...`）
- ✅ 确保旧版不受影响
- ✅ 完整的单元测试

**开发流程**:
1. 明确新功能需求
2. 设计新接口（RESTful 规范）
3. 后端开发 + 测试
4. 前端对接
5. 集成测试
6. 回归测试（确保旧版正常）

---

## ⚠️ 风险控制

### 风险点 1: 样式冲突
**风险**: 新旧版 CSS 互相影响

**解决方案**:
- 新版 CSS 使用独立的 class 前缀（如 `.v2-`）
- 使用独立的 CSS 文件，不共享
- 避免使用全局样式
- 必要时使用 CSS Modules 或 scoped styles

**验证方法**:
- 同时打开新旧版页面，检查样式是否正常

---

### 风险点 2: 后端接口变更
**风险**: 为新版修改接口导致旧版失效

**解决方案**:
- ✅ **只新增接口，不修改现有接口**
- 如需修改，创建新版本接口（如 `/api/v2/...`）
- 完整的回归测试
- API 版本化管理

**验证方法**:
- 每次后端改动后测试旧版所有功能

---

### 风险点 3: 数据库迁移
**风险**: 数据结构变更影响旧版

**解决方案**:
- 只增加字段，不删除/修改现有字段
- 使用数据库迁移脚本（可回滚）
- 测试环境先验证
- 生产环境备份后操作

**验证方法**:
- 在测试数据库上先执行迁移
- 验证旧版功能正常后再上生产

---

### 风险点 4: 粒子币计算错误
**风险**: 扣费逻辑不一致导致余额异常

**解决方案**:
- 严格遵循现有计费规则
- 前端预扣 + 后端去重
- 充分测试边界情况
- 添加扣费日志

**验证方法**:
- 测试各种生成场景
- 验证扣费和退款逻辑
- 检查交易记录

---

### 风险点 5: localStorage 冲突
**风险**: 新旧版 localStorage 数据冲突

**解决方案**:
- Token 使用相同的 key（`auth_token`）- 共享登录状态
- 其他数据使用不同前缀（v1_xxx, v2_xxx）
- 避免覆盖对方的缓存数据

**验证方法**:
- 测试登录后在新旧版切换
- 验证数据不互相覆盖

---

## ✅ 验收标准

### 功能完整性
- [ ] 所有核心功能正常（参考 FEATURE_CHECKLIST.md 162项）
- [ ] 新旧版数据共享正常（登录、积分、历史）
- [ ] 旧版功能100%可用
- [ ] 无重复扣费问题
- [ ] 历史记录正确同步

### 性能指标
- [ ] 页面加载时间 < 2s
- [ ] API 响应时间 < 1s
- [ ] 图片懒加载正常
- [ ] 内存占用合理

### 用户体验
- [ ] UI 符合设计稿
- [ ] 交互流畅无卡顿
- [ ] 错误提示友好
- [ ] 加载状态明确
- [ ] 无明显 Bug

### 兼容性
- [ ] Chrome 最新版
- [ ] Edge 最新版
- [ ] Safari 最新版
- [ ] 旧版功能不受影响

### 安全性
- [ ] Token 安全存储
- [ ] API 调用安全
- [ ] 无 XSS 漏洞
- [ ] 无敏感信息泄露

---

## 🔄 回滚方案

### 场景 1: 前端出现严重问题

**回滚步骤**:
1. 停止访问新版页面（修改 Nginx 配置）
2. 恢复备份: `tar -xzf backups/backup_v2_init_*.tar.gz`
3. 验证旧版功能正常

**影响**: 无，旧版不受影响

---

### 场景 2: 后端新增接口有问题

**回滚步骤**:
1. 注释新增的路由
2. 重启后端服务
3. 验证旧版功能正常

**影响**: 新版功能受限，旧版不受影响

---

### 场景 3: 数据库迁移失败

**回滚步骤**:
1. 停止服务
2. 恢复数据库备份: `cp data/users.db.backup data/users.db`
3. 回滚代码
4. 重启服务

**影响**: 回滚期间的新数据丢失

---

## 💾 数据备份策略

### 开发前备份
```bash
# 创建时间戳备份
cp data/users.db data/users.db.backup_$(date +%Y%m%d_%H%M%S)

# 代码备份（已完成）
tar -czf backups/backup_v2_init_$(date +%Y%m%d_%H%M%S).tar.gz frontend/ backend/ docs/
```

### 关键节点备份
- 阶段1完成后备份
- 阶段2完成后备份
- 上线前完整备份
- 每次数据库迁移前备份

### 备份保留策略
- 最近7天: 每天备份
- 最近1个月: 每周备份
- 长期保存: 重要里程碑备份

---

## 📊 时间估算

| 阶段 | 预计时间 | 累计时间 | 状态 |
|------|---------|---------|------|
| 准备工作 | 0.5天 | 0.5天 | ✅ 已完成 |
| 阶段1: 前端框架 | 1-2天 | 1.5-2.5天 | 🔄 进行中 |
| 阶段2: 接口接入 | 2-3天 | 3.5-5.5天 | ⏳ 未开始 |
| 阶段3: 样式优化 | 1-2天 | 4.5-7.5天 | ⏳ 未开始 |
| 阶段4: 新功能（可选） | 按需 | - | ⏳ 待定 |
| **总计** | **4.5-7.5天** | - | - |

---

## 📝 开发日志

### 2025-11-14
- [x] 创建项目规划文档
- [x] 准备参考文档（API规格、功能清单）
- [x] 创建 v2 目录结构
- [x] 备份现有代码 (`backups/backup_v2_init_20251114_051203.tar.gz`)
- [ ] 等待用户提供 HTML 代码

---

## 📚 参考文档

### 核心文档（位于 frontend/v2/docs/）
1. `API_SPECIFICATION.md` - 后端 API 完整规格（10个接口）
2. `FEATURE_CHECKLIST.md` - 功能对照清单（162项）
3. `FRONTEND_INTEGRATION_GUIDE.md` - 前端接入指南
4. `DEVELOPMENT_LOG.md` - 详细开发日志

### 项目文档（位于根目录）
1. `CURRENT_STATE.md` - 项目当前状态
2. `README.md` - 项目总体介绍

---

## 🔗 技术栈

### 前端
- **核心**: 原生 JavaScript (ES6+)
- **模块化**: ES6 Modules
- **样式**: 原生 CSS
- **架构**: 模块化设计（AuthManager, ImageGenerator, HistoryManager）

### 后端（共享）
- **框架**: FastAPI
- **数据库**: SQLite
- **认证**: JWT Token
- **API**: RESTful

### 共享机制
- **Token**: localStorage.auth_token
- **数据**: 后端数据库（users, tasks, images）
- **接口**: 相同的 API 端点

---

## 👥 团队协作

### 角色分工
- **用户**: 提供 HTML 设计、需求说明
- **AI Assistant**: 实现功能、接入 API、调试优化

### 沟通机制
- 每个阶段完成后确认
- 遇到问题及时沟通
- 记录开发日志

---

## 🎯 成功标准

### 最终目标
✅ 新版页面完全可用
✅ 旧版功能不受影响
✅ 数据共享正常
✅ 用户体验优秀

### 交付清单
- [ ] 完整的前端代码
- [ ] 详细的开发文档
- [ ] 测试报告
- [ ] 部署指南

---

**项目状态**: 🚀 进行中
**当前阶段**: 阶段1 - 前端框架搭建
**维护者**: AI Assistant
**创建时间**: 2025-11-14
**最后更新**: 2025-11-14
