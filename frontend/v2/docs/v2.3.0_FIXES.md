# V2.3.0 é‡å¤§ä¿®å¤è¯´æ˜

**ç‰ˆæœ¬**: 2.3.0
**å‘å¸ƒæ—¶é—´**: 2025-11-14
**ä¿®å¤ç±»å‹**: ä¸¥é‡Bugä¿®å¤

---

## ğŸ› ä¿®å¤çš„ä¸¥é‡é—®é¢˜

### 1. âœ… ç³»åˆ—å›¾APIè°ƒç”¨é€»è¾‘é”™è¯¯ï¼ˆæœ€ä¸¥é‡ï¼‰

**é—®é¢˜æè¿°**ï¼š
- æ—§ç‰ˆæœ¬é”™è¯¯åœ°å°†ç³»åˆ—å›¾å®ç°ä¸ºå¤šæ¬¡è°ƒç”¨ `image_to_image`ï¼Œæ¯æ¬¡ç”Ÿæˆ1å¼ 
- å¯¼è‡´è´¹ç”¨æŒ‰ç”Ÿæˆå¼ æ•°é‡å¤æ‰£é™¤ï¼ˆåº”è¯¥å›ºå®š2å¸ï¼Œç»“æœæ‰£äº†4å¸ç”Ÿæˆ4å¼ ï¼‰
- ä¸¢å¤±äº† `mode: "conversation"` å‚æ•°
- æ— æ³•å®ç°çº¯æ–‡å­—ç³»åˆ—å›¾

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- é‡å†™ `frontend/v2/js/api/image.js`
- ç³»åˆ—å›¾ç°åœ¨æ­£ç¡®ä½¿ç”¨ `mode: "conversation"` å‚æ•°
- å›ºå®šæ‰£2ä¸ªç²’å­å¸ï¼Œä¸€æ¬¡è°ƒç”¨è¿”å›1-4å¼ 
- æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
  - æœ‰å‚è€ƒå›¾ï¼š`conversationWithImages()` â†’ è°ƒç”¨ `/run/edit_image`
  - æ— å‚è€ƒå›¾ï¼š`conversationWithoutImages()` â†’ è°ƒç”¨ `/run/generate_image`
- åˆ é™¤ `description` å­—æ®µï¼ˆAPIè¿”å›ï¼Œä½†å‰ç«¯ä¸éœ€è¦ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```javascript
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
async generateSeries() {
    for (let i = 0; i < count; i++) {
        await this.imageToImage({ count: 1 }); // å¤šæ¬¡è°ƒç”¨ï¼Œé‡å¤æ‰£è´¹
    }
}

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
async conversationWithImages() {
    formData.append('model_params', JSON.stringify({
        response_modalities: ['Text', 'Image'],
        mode: 'conversation', // â† å…³é”®å‚æ•°
        aspect_ratio: aspectRatio
    }));
    return await apiClient.postFormData(endpoint, formData); // ä¸€æ¬¡è°ƒç”¨
}
```

---

### 2. âœ… æ¨¡å¼æ£€æµ‹é€»è¾‘é”™è¯¯

**é—®é¢˜æè¿°**ï¼š
- æ—§ç‰ˆæœ¬ï¼šåªè¦ä¸Šä¼ â‰¥2å¼ å›¾å°±è¿”å› `'series'`ï¼Œå³ä½¿æ²¡æœ‰å¼€å¯ç³»åˆ—å›¾å¼€å…³
- å¯¼è‡´ç”¨æˆ·æ— æ³•ä¸€æ¬¡æ€§æäº¤å¤šå¼ å‚è€ƒå›¾ç»™å›¾ç”Ÿå›¾æ¨¡å¼
- ç³»åˆ—å›¾å¼€å…³åœ¨æ— å›¾æ—¶å®Œå…¨å¤±æ•ˆ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- é‡å†™ `detectMode()` é€»è¾‘ï¼Œä¿®æ”¹ä¼˜å…ˆçº§ï¼š
  ```javascript
  detectMode(uploadedImages, seriesMode) {
      // ä¼˜å…ˆçº§1: ç³»åˆ—å›¾å¼€å…³
      if (seriesMode) return 'series';

      // ä¼˜å…ˆçº§2: æ— å›¾ â†’ æ–‡ç”Ÿå›¾
      if (imageCount === 0) return 'text-to-image';

      // ä¼˜å…ˆçº§3: æœ‰å›¾ â†’ å›¾ç”Ÿå›¾ï¼ˆæ”¯æŒå¤šå¼ å‚è€ƒå›¾ï¼‰
      return 'image-to-image';
  }
  ```

---

### 3. âœ… uploadedImages çŠ¶æ€ç®¡ç†æ··ä¹±

**é—®é¢˜æè¿°**ï¼š
- é‡æ–°ä¸Šä¼ åŒä¸€æ§½ä½æ—¶ï¼Œä¸ä¼šåˆ é™¤æ—§çš„æ¡ç›®ï¼ŒMapä¼šä¸€ç›´å¢å¤§
- åˆ é™¤é™„åŠ è¡Œæ—¶ï¼Œæ²¡æœ‰ä» `uploadedImages` ä¸­åˆ é™¤è¯¥è¡Œçš„å›¾ç‰‡
- å¯¼è‡´"å¹½çµå›¾ç‰‡"è¢«æäº¤åˆ°åç«¯ï¼Œæ¨¡å¼æ£€æµ‹å‡ºé”™

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ·»åŠ  `detachLabelImage()` å‡½æ•°ï¼Œåœ¨é‡æ–°ä¸Šä¼ æ—¶å…ˆæ¸…ç†æ—§æ•°æ®ï¼š
  ```javascript
  function detachLabelImage(labelElement) {
      const existingId = labelElement.dataset.imageId;
      if (existingId) {
          uploadedImages.delete(existingId); // åˆ é™¤æ—§æ•°æ®
          delete labelElement.dataset.imageId;
      }
  }
  ```
- åœ¨ `handleImageUpload()` ä¸­è°ƒç”¨ï¼š
  ```javascript
  detachLabelImage(labelElement); // å…ˆæ¸…ç†æ—§å›¾ç‰‡
  const imageId = `img_${imageIdCounter++}`; // å†æ·»åŠ æ–°å›¾ç‰‡
  uploadedImages.set(imageId, { file, dataUrl, name });
  labelElement.dataset.imageId = imageId; // å…³è”æ§½ä½å’ŒID
  ```
- åˆ é™¤è¡Œæ—¶æ¸…ç†è¯¥è¡Œæ‰€æœ‰å›¾ç‰‡ï¼š
  ```javascript
  const labels = rowElement.querySelectorAll('label');
  labels.forEach(label => detachLabelImage(label)); // æ¸…ç†æ‰€æœ‰å›¾ç‰‡
  rowElement.remove();
  ```

---

### 4. âœ… ç™»å½•/ä½™é¢UIå§‹ç»ˆæ˜¾ç¤ºå ä½ç¬¦

**é—®é¢˜æè¿°**ï¼š
- ç•Œé¢å³ä¸Šè§’ç¡¬ç¼–ç  "100 Credits" å’Œå­—æ¯ "U"
- `updateUserUI()` ä¸­çš„é€‰æ‹©å™¨ä¸æ­£ç¡®ï¼Œæ— æ³•æ›´æ–°UI
- æœªç™»å½•æ—¶ä¸æ˜¾ç¤º "-- Credits"

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ·»åŠ  `data-role` å±æ€§åˆ°HTMLå…ƒç´ ï¼š
  ```html
  <span data-role="credits-display">-- Credits</span>
  <div data-role="user-avatar" title="æœªç™»å½•">?</div>
  ```
- ä¿®å¤ `app.js` ä¸­çš„ `updateUserUI()` é€‰æ‹©å™¨ï¼š
  ```javascript
  updateUserUI() {
      const creditsEl = document.querySelector('[data-role="credits-display"]');
      creditsEl.textContent = this.currentUser
          ? `${this.currentUser.particles} Credits`
          : '-- Credits';

      const avatarEl = document.querySelector('[data-role="user-avatar"]');
      avatarEl.textContent = this.currentUser
          ? this.currentUser.username.charAt(0).toUpperCase()
          : '?';
  }
  ```
- åˆå§‹åŒ–æ—¶è°ƒç”¨ `updateUserUI()` æ˜¾ç¤ºé»˜è®¤çŠ¶æ€

---

### 5. âœ… Tokenå¤±æ•ˆæ—¶UIä¸ä¼šè‡ªåŠ¨æ›´æ–°

**é—®é¢˜æè¿°**ï¼š
- APIClient åœ¨ 401 æ—¶åªæ¸…é™¤ localStorageï¼Œä½†ä¸æ›´æ–° `V2App` çŠ¶æ€
- ç”¨æˆ·ä¾æ—§çœ‹åˆ°æ—§çš„æ˜µç§°å’Œä½™é¢ï¼Œä½†æ‰€æœ‰æ“ä½œéƒ½æŠ¥"æœªç™»å½•"

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `handleLogout()` æ”¯æŒä¸åˆ·æ–°é¡µé¢çš„ç™»å‡ºï¼š
  ```javascript
  handleLogout(options = { reload: true }) {
      this.auth.logout();
      this.currentUser = null;
      this.isLoggedIn = false;
      this.updateUserUI(); // æ›´æ–°UI

      if (options.reload !== false) {
          window.location.reload();
      }
  }
  ```
- åœ¨ `handleGenerate()` ä¸­æ•è·401é”™è¯¯ï¼š
  ```javascript
  catch (error) {
      if (error.message && error.message.includes('ç™»å½•å·²è¿‡æœŸ')) {
          this.handleLogout({ reload: false }); // ä¸åˆ·æ–°é¡µé¢
      }
      return { success: false, message: error.message };
  }
  ```

---

## ğŸ“Š ä¿®å¤å¯¹æ¯”è¡¨

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç³»åˆ—å›¾æ‰£è´¹ | æŒ‰å¼ æ•°æ‰£è´¹ï¼ˆ4å¼ æ‰£4å¸ï¼‰ | å›ºå®šæ‰£2å¸ |
| ç³»åˆ—å›¾è°ƒç”¨æ¬¡æ•° | å¤šæ¬¡è°ƒç”¨ï¼ˆ4æ¬¡ï¼‰ | ä¸€æ¬¡è°ƒç”¨ |
| å¤šå›¾å‚è€ƒå›¾ | è¢«åˆ¤å®šä¸ºç³»åˆ—å›¾ | æ­£å¸¸å›¾ç”Ÿå›¾ |
| çº¯æ–‡å­—ç³»åˆ—å›¾ | æ— æ³•è§¦å‘ | å¯æ­£å¸¸ä½¿ç”¨ |
| é‡æ–°ä¸Šä¼ å›¾ç‰‡ | æ—§å›¾ç‰‡æ®‹ç•™åœ¨Map | è‡ªåŠ¨æ¸…ç†æ—§å›¾ç‰‡ |
| åˆ é™¤è¡Œ | å›¾ç‰‡æ®‹ç•™åœ¨Map | è‡ªåŠ¨æ¸…ç†è¡Œå†…æ‰€æœ‰å›¾ç‰‡ |
| æœªç™»å½•UI | æ˜¾ç¤º"100 Credits" | æ˜¾ç¤º"-- Credits" |
| Tokenå¤±æ•ˆ | UIä¸æ›´æ–° | è‡ªåŠ¨ç™»å‡ºå¹¶æ›´æ–°UI |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### ç³»åˆ—å›¾æµ‹è¯•

**æµ‹è¯•1: çº¯æ–‡å­—ç³»åˆ—å›¾ï¼ˆå›ºå®š2å¸ï¼‰**
```javascript
// 1. å¼€å¯ç³»åˆ—å›¾å¼€å…³
// 2. ä¸ä¸Šä¼ å›¾ç‰‡
// 3. è¾“å…¥æç¤ºè¯ï¼š"ç”Ÿæˆä¸€ç»„æœªæ¥åŸå¸‚çš„æ¦‚å¿µå›¾"
// 4. ç‚¹å‡»ç”Ÿæˆ

// é¢„æœŸç»“æœï¼š
// - æ§åˆ¶å°æ˜¾ç¤ºï¼šmode: "series"
// - ç²’å­å¸å‡å°‘2å¸ï¼ˆä¸æ˜¯æŒ‰å¼ æ•°æ‰£è´¹ï¼‰
// - è¿”å›1-4å¼ å›¾ç‰‡
```

**æµ‹è¯•2: æœ‰å‚è€ƒå›¾çš„ç³»åˆ—å›¾ï¼ˆå›ºå®š2å¸ï¼‰**
```javascript
// 1. ä¸Šä¼ 1-3å¼ å‚è€ƒå›¾
// 2. å¼€å¯ç³»åˆ—å›¾å¼€å…³
// 3. è¾“å…¥æç¤ºè¯ï¼š"åŸºäºè¿™äº›å›¾ç‰‡ï¼Œç”Ÿæˆä¸€ç³»åˆ—å˜ä½“"
// 4. ç‚¹å‡»ç”Ÿæˆ

// é¢„æœŸç»“æœï¼š
// - æ§åˆ¶å°æ˜¾ç¤ºï¼šmode: "series" | å‚è€ƒå›¾æ•°é‡: 3
// - ç²’å­å¸å‡å°‘2å¸
// - è¿”å›1-4å¼ å›¾ç‰‡
```

**æµ‹è¯•3: å¤šå¼ å‚è€ƒå›¾çš„æ™®é€šå›¾ç”Ÿå›¾ï¼ˆæŒ‰å¼ æ•°æ‰£è´¹ï¼‰**
```javascript
// 1. ä¸Šä¼ 3å¼ å‚è€ƒå›¾
// 2. ä¸å¼€å¯ç³»åˆ—å›¾å¼€å…³
// 3. é€‰æ‹©ç”Ÿæˆ4å¼ 
// 4. è¾“å…¥æç¤ºè¯ï¼š"å°†è¿™äº›çŒ«å’ªå˜æˆå¡é€šé£æ ¼"
// 5. ç‚¹å‡»ç”Ÿæˆ

// é¢„æœŸç»“æœï¼š
// - æ§åˆ¶å°æ˜¾ç¤ºï¼šmode: "image-to-image" | å‚è€ƒå›¾æ•°é‡: 3
// - ç²’å­å¸å‡å°‘4å¸ï¼ˆ1å¸/å¼ ï¼‰
// - è¿”å›4å¼ å›¾ç‰‡
// - æ‰€æœ‰3å¼ å‚è€ƒå›¾éƒ½è¢«å‘é€åˆ°API
```

### çŠ¶æ€ç®¡ç†æµ‹è¯•

**æµ‹è¯•4: é‡æ–°ä¸Šä¼ åŒä¸€æ§½ä½**
```javascript
// 1. ä¸»ä¸Šä¼ æ¡†ä¸Šä¼  cat.jpg
// 2. æ§åˆ¶å°æŸ¥çœ‹ï¼šuploadedImages.size === 1
// 3. ä¸»ä¸Šä¼ æ¡†é‡æ–°ä¸Šä¼  dog.jpg
// 4. æ§åˆ¶å°æŸ¥çœ‹ï¼šuploadedImages.size === 1 ï¼ˆä¸æ˜¯2ï¼‰

// é¢„æœŸç»“æœï¼š
// - Mapä¸­åªæœ‰1å¼ å›¾ç‰‡ï¼ˆdog.jpgï¼‰
// - cat.jpgå·²è¢«è‡ªåŠ¨åˆ é™¤
```

**æµ‹è¯•5: åˆ é™¤é™„åŠ è¡Œ**
```javascript
// 1. æ·»åŠ 1è¡Œé™„åŠ ä¸Šä¼ ï¼ˆ2ä¸ªæ§½ä½ï¼‰
// 2. ä¸¤ä¸ªæ§½ä½éƒ½ä¸Šä¼ å›¾ç‰‡
// 3. æ§åˆ¶å°æŸ¥çœ‹ï¼šuploadedImages.size === 3 ï¼ˆ1ä¸»å›¾+2é™„åŠ ï¼‰
// 4. ç‚¹å‡»åˆ é™¤è¡ŒæŒ‰é’®
// 5. æ§åˆ¶å°æŸ¥çœ‹ï¼šuploadedImages.size === 1 ï¼ˆåªå‰©ä¸»å›¾ï¼‰

// é¢„æœŸç»“æœï¼š
// - åˆ é™¤è¡Œæ—¶ï¼Œè¯¥è¡Œçš„2å¼ å›¾ç‰‡éƒ½è¢«æ¸…ç†
```

### UIæµ‹è¯•

**æµ‹è¯•6: æœªç™»å½•çŠ¶æ€UI**
```javascript
// 1. æ‰“å¼€é¡µé¢ï¼ˆæœªç™»å½•ï¼‰
// 2. æŸ¥çœ‹å³ä¸Šè§’

// é¢„æœŸç»“æœï¼š
// - æ˜¾ç¤º "-- Credits"
// - å¤´åƒæ˜¾ç¤º "?"
// - titleæ˜¾ç¤º "æœªç™»å½•"
```

**æµ‹è¯•7: Tokenå¤±æ•ˆUI**
```javascript
// 1. æ§åˆ¶å°ç™»å½•
// 2. æ‰‹åŠ¨åˆ é™¤tokenï¼šlocalStorage.removeItem('auth_token')
// 3. ç‚¹å‡»ç”ŸæˆæŒ‰é’®

// é¢„æœŸç»“æœï¼š
// - ç”Ÿæˆå¤±è´¥ï¼Œæç¤º"ç™»å½•å·²è¿‡æœŸ"
// - Creditsè‡ªåŠ¨å˜ä¸º "-- Credits"
// - å¤´åƒè‡ªåŠ¨å˜ä¸º "?"
// - æ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. **frontend/v2/js/api/image.js**
   - é‡å†™ç³»åˆ—å›¾å®ç°
   - æ·»åŠ  `conversationWithImages()` å’Œ `conversationWithoutImages()`
   - ä¿®å¤ `detectMode()` é€»è¾‘
   - åˆ é™¤é”™è¯¯çš„ `generateSeries()` æ–¹æ³•

2. **frontend/v2/js/app.js**
   - ä¿®å¤ `updateUserUI()` é€‰æ‹©å™¨
   - ä¿®æ”¹ `handleLogout()` æ”¯æŒä¸åˆ·æ–°é¡µé¢
   - åœ¨ `handleGenerate()` ä¸­å¤„ç†401é”™è¯¯

3. **frontend/v2/index.html**
   - æ·»åŠ  `data-role` å±æ€§
   - æ·»åŠ  `detachLabelImage()` å‡½æ•°
   - ä¿®å¤åˆ é™¤è¡Œæ—¶æ¸…ç†å›¾ç‰‡
   - ä¿®å¤é‡æ–°ä¸Šä¼ æ—¶æ¸…ç†æ—§å›¾ç‰‡
   - æ›´æ–°ç‰ˆæœ¬å·åˆ° 2.3.0

---

## ğŸ¯ ä¸‹ä¸€æ­¥

è¿™äº›ä¿®å¤è§£å†³äº†æ‰€æœ‰æ ¸å¿ƒé—®é¢˜ï¼Œç°åœ¨å¯ä»¥ï¼š
1. âœ… æ­£ç¡®ä½¿ç”¨ç³»åˆ—å›¾æ¨¡å¼ï¼ˆå›ºå®š2å¸ï¼‰
2. âœ… å¤šå¼ å‚è€ƒå›¾æ­£å¸¸å·¥ä½œ
3. âœ… çŠ¶æ€ç®¡ç†å®Œå…¨åŒæ­¥
4. âœ… UIæ­£ç¡®æ˜¾ç¤ºç™»å½•çŠ¶æ€

**å¯ä»¥é‡æ–°æµ‹è¯•äº†ï¼**
