<!DOCTYPE html>
<html lang="zh-CN"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>ç²’å­AIç”Ÿå›¾ V2</title>
<!-- Version: 2.3.0 - ä¿®å¤ç³»åˆ—å›¾APIé€»è¾‘å’ŒçŠ¶æ€ç®¡ç† -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<!-- å¼•å…¥ Material Symbols å›¾æ ‡åº“ -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
<!-- V2ç‹¬ç«‹æ ·å¼æ–‡ä»¶ -->
<link href="/v2/css/main.css?v=221" rel="stylesheet"/>
<!-- å¼•å…¥V2åº”ç”¨æ¨¡å— -->
<script type="module" src="/v2/js/app.js?v=20251114023"></script>
<style>
    /* é˜²æ­¢FOUC - é¡µé¢åŠ è½½æ—¶éšè—å†…å®¹ */
    body:not(.loaded) {
        opacity: 0;
    }
    body.loaded {
        opacity: 1;
        transition: opacity 0.3s ease-in;
    }

    /* é˜²æ­¢Material IconsåŠ è½½æ—¶æ˜¾ç¤ºæ–‡æœ¬ */
    .material-symbols-outlined {
        font-display: block;
    }
    body:not(.loaded) .material-symbols-outlined {
        visibility: hidden;
    }

    /* æŠ˜å æ•ˆæœ - å†…è”ç¡®ä¿ç”Ÿæ•ˆ */
    .v2-app .v2-sidebar.is-collapsed .v2-hide-on-collapse {
        display: none !important;
    }
    .v2-app .v2-sidebar.is-collapsed .v2-sidebar-text {
        display: none !important;
    }
    .v2-app .v2-sidebar.is-collapsed .v2-sidebar-full-content {
        display: none !important;
    }
    .v2-app .v2-sidebar.is-collapsed .v2-sidebar-icon-content {
        display: flex !important;
    }

    /* ğŸ”‘ ä¿®å¤1: è§£å†³æŠ˜å /å±•å¼€æ—¶çš„å†…å®¹é—ªçƒé—®é¢˜ */
    .v2-sidebar .v2-sidebar-full-content,
    .v2-sidebar .v2-sidebar-icon-content {
        transition: opacity 0.15s ease-out;
    }
    /* åœ¨æŠ˜å /å±•å¼€åŠ¨ç”»æœŸé—´éšè—å†…å®¹ */
    .v2-sidebar.transitioning .v2-sidebar-full-content,
    .v2-sidebar.transitioning .v2-sidebar-icon-content {
        opacity: 0;
    }
    /* å±•å¼€çŠ¶æ€ï¼ˆéæŠ˜å ï¼Œétransitioningï¼‰ */
    .v2-sidebar:not(.is-collapsed):not(.transitioning) .v2-sidebar-full-content {
        opacity: 1;
    }
    /* æŠ˜å çŠ¶æ€ï¼ˆæŠ˜å ï¼Œétransitioningï¼‰ */
    .v2-sidebar.is-collapsed:not(.transitioning) .v2-sidebar-icon-content {
        opacity: 1;
    }

    /* ğŸ”‘ ä¿®å¤2: æŠ˜å æŒ‰é’®å›ºå®šåœ¨åˆ†ç•Œçº¿ä¸Šï¼Œä¸éšä¾§è¾¹æ å®½åº¦å˜åŒ– */
    #sidebar-toggle-btn {
        position: fixed !important;
        left: 340px !important; /* é»˜è®¤å±•å¼€æ—¶çš„ä½ç½®ï¼š340px - 3.5 = 336.5px */
        transform: translateX(-50%) translateY(-50%) !important;
        transition: left 0.3s ease !important;
    }
    .v2-sidebar.is-collapsed ~ * #sidebar-toggle-btn,
    .v2-sidebar.is-collapsed #sidebar-toggle-btn {
        left: 80px !important; /* æŠ˜å æ—¶çš„ä½ç½®ï¼š80px / 2 = 40px */
    }

    /* ğŸ”‘ ä¿®å¤3: æŠ˜å æ—¶çš„ç¼©ç•¥å›¾å®¹å™¨ */
    .v2-collapsed-thumbnails {
        display: none;
    }
    .v2-sidebar.is-collapsed .v2-collapsed-thumbnails {
        display: grid !important;
        grid-template-columns: 1fr;
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
    }
    .v2-collapsed-thumbnail {
        width: 48px;
        height: 48px;
        border-radius: 0.75rem;
        overflow: hidden;
        position: relative;
        cursor: pointer;
    }
    .v2-collapsed-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .v2-collapsed-thumbnail:hover::after {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.2);
    }
    .v2-app .v2-sidebar-icon-content {
        display: none;
        align-items: center;
        justify-content: center;
    }

    /* textareaæŒ‰é’®å›ºå®šä½ç½® - ç›¸å¯¹è¾“å…¥æ¡†å±…ä¸­ */
    #prompt-wrapper .absolute.right-3 {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
    }
</style>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,typography"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#3b82f6", // blue-500
                        "background-light": "#ffffff", // white
                        "background-dark": "#18181b", // zinc-900
                        "sidebar-yellow": "#FFD900",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.75rem", // rounded-xl
                        'full': '9999px',
                    },
                },
            },
        };
    </script>
</head>
<body class="bg-background-light dark:bg-zinc-800 font-display text-gray-800 dark:text-gray-200">

    <!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
    <div id="v2AuthModal" class="v2-app v2-auth-modal">
        <div class="v2-auth-modal-content">
            <!-- å…³é—­æŒ‰é’® -->
            <button id="v2AuthCloseBtn" class="v2-auth-close">Ã—</button>

            <!-- æ ‡é¢˜ -->
            <div class="v2-auth-modal-header">
                <h2 class="v2-auth-modal-title">æ¬¢è¿ä½¿ç”¨</h2>
                <p class="v2-auth-modal-subtitle">ç²’å­AIå›¾ç‰‡å¹³å°</p>
            </div>

            <!-- Tabåˆ‡æ¢ -->
            <div class="v2-auth-tabs">
                <button class="v2-auth-tab active" data-tab="login">ç™»å½•</button>
                <button class="v2-auth-tab" data-tab="register">æ³¨å†Œ</button>
            </div>

            <!-- é”™è¯¯/æˆåŠŸæç¤º -->
            <div class="v2-auth-error" id="v2AuthError"></div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="v2LoginForm" class="v2-auth-form">
                <div class="v2-auth-form-group">
                    <label class="v2-auth-label">ç”¨æˆ·å</label>
                    <input type="text" class="v2-auth-input" id="v2LoginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="v2-auth-form-group">
                    <label class="v2-auth-label">å¯†ç </label>
                    <input type="password" class="v2-auth-input" id="v2LoginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="v2-auth-submit-btn">ç™»å½•</button>
            </form>

            <!-- æ³¨å†Œè¡¨å• -->
            <form id="v2RegisterForm" class="v2-auth-form" style="display: none;">
                <div class="v2-auth-form-group">
                    <label class="v2-auth-label">ç”¨æˆ·å</label>
                    <input type="text" class="v2-auth-input" id="v2RegisterUsername" placeholder="è‡³å°‘3ä¸ªå­—ç¬¦" required>
                </div>
                <div class="v2-auth-form-group">
                    <label class="v2-auth-label">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="email" class="v2-auth-input" id="v2RegisterEmail" placeholder="your@email.com">
                </div>
                <div class="v2-auth-form-group">
                    <label class="v2-auth-label">å¯†ç </label>
                    <input type="password" class="v2-auth-input" id="v2RegisterPassword" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦" required>
                </div>
                <div class="v2-auth-form-group">
                    <label class="v2-auth-label">ç¡®è®¤å¯†ç </label>
                    <input type="password" class="v2-auth-input" id="v2RegisterPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="v2-auth-submit-btn">æ³¨å†Œå¹¶è·å¾—30ä¸ªç²’å­å¸</button>
            </form>
        </div>
    </div>

<div class="v2-app flex h-screen w-full bg-white dark:bg-zinc-900">

<!-- 1. å·¦ä¾§ä¾§è¾¹æ  -->
<aside id="sidebar" class="v2-sidebar w-[340px] p-6 bg-sidebar-yellow dark:bg-sidebar-yellow text-black flex flex-col gap-6 shrink-0 relative transition-all duration-300">
    
    <!-- å±•å¼€æ—¶çš„ Logo å’Œæ ‡é¢˜ -->
    <div class="flex items-center justify-between v2-sidebar-full-content">
        <div class="flex items-center gap-3">
            <div class="flex flex-col">
                <div class="flex items-center space-x-1">
                    <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
                    <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
                    <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
                </div>
                <div class="flex items-center space-x-1 mt-1">
                    <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
                    <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
                </div>
            </div>
            <h1 class="font-bold text-lg tracking-wider v2-sidebar-text">åŸºæœ¬ç²’å­</h1>
        </div>
    </div>
    
    <!-- æŠ˜å æ—¶çš„ Logo å›¾æ ‡ -->
    <div class="v2-sidebar-icon-content h-10">
        <div class="flex flex-col">
            <div class="flex items-center space-x-1">
                <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
                <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
                <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
            </div>
            <div class="flex items-center space-x-1 mt-1">
                <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
                <span class="w-1.5 h-1.5 bg-black rounded-full"></span>
            </div>
        </div>
    </div>
    
    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="space-y-4">
        <div class="flex justify-between items-center v2-sidebar-full-content">
            <span class="text-sm font-semibold v2-sidebar-text">ä¸Šä¼ å›¾ç‰‡</span>
            <button id="add-upload-row-btn" class="w-8 h-8 flex items-center justify-center bg-black/5 rounded-lg text-xl hover:bg-black/10 transition-colors">+</button>
        </div>
        <!-- (å·²ä¿®æ”¹) æ­£æ–¹å½¢ (aspect-square), æ–°å›¾æ ‡ (add_photo_alternate) -->
        <label for="main-image-upload" class="flex flex-col items-center justify-center w-full aspect-square border-2 border-dashed border-black/20 rounded-xl bg-black/5 v2-pattern-bg cursor-pointer hover:border-black/40 v2-sidebar-full-content" data-slot="main">
            <span class="material-symbols-outlined text-6xl text-black/30">add_photo_alternate</span>
        </label>
        <input id="main-image-upload" type="file" class="sr-only">

        <!-- æŠ˜å æ—¶çš„ä¸Šä¼ å›¾æ ‡ -->
        <label for="main-image-upload-icon" class="v2-sidebar-icon-content w-12 h-12 bg-black/5 rounded-xl cursor-pointer hover:bg-black/10" data-slot="main">
            <span class="material-symbols-outlined text-3xl text-black/50">add_photo_alternate</span>
        </label>
        <input id="main-image-upload-icon" type="file" class="sr-only">

        <!-- ğŸ”‘ ä¿®å¤3: æŠ˜å æ—¶æ˜¾ç¤ºçš„ç¼©ç•¥å›¾å®¹å™¨ -->
        <div id="collapsed-thumbnails-container" class="v2-collapsed-thumbnails">
            <!-- JSåŠ¨æ€å¡«å……ç¼©ç•¥å›¾ -->
        </div>

        <!-- åŠ¨æ€ä¸Šä¼ æ¡†å®¹å™¨ -->
        <div id="additional-uploads-container" class="space-y-2 v2-sidebar-full-content">
            <!-- JS åŠ¨æ€æ·»åŠ ä¸Šä¼ æ¡† -->
        </div>
    </div>
    
    <!-- å°ºå¯¸åŒºåŸŸ -->
    <div class="space-y-4">
        <h3 class="text-sm font-semibold v2-sidebar-text v2-sidebar-full-content">å°ºå¯¸</h3>
        <div class="relative v2-sidebar-full-content" id="aspect-ratio-wrapper">
            <!-- æ˜¾ç¤ºå½“å‰é€‰æ‹©çš„æŒ‰é’® -->
            <button id="current-aspect-ratio-btn" class="flex items-center justify-between w-full bg-white/50 border border-black/10 rounded-xl text-black py-3 px-4 transition-all hover:bg-white/80">
                <span id="current-aspect-ratio-display" class="flex items-center gap-2">
                    <span class="w-4 h-4 bg-gray-600 rounded-sm inline-block"></span>
                    <span class="font-medium v2-sidebar-text">1:1</span>
                </span>
                <span class="material-symbols-outlined text-black/40 v2-sidebar-text">expand_more</span>
            </button>
            
            <!-- (å·²ä¿®æ”¹) è¦æ±‚ 1: 5ä¸ªé€‰é¡¹, é€æ˜èƒŒæ™¯ (bg-white/50 backdrop-blur-sm), z-50 -->
            <div id="aspect-ratio-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white/50 backdrop-blur-sm border border-black/10 rounded-lg shadow-lg">
                <div id="aspect-ratio-group" class="grid grid-cols-5 gap-1 p-2">
                    <button class="aspect-ratio-btn flex items-center justify-center bg-transparent border border-transparent p-2 rounded-lg text-sm text-text-light hover:border-black/50 data-[active=true]:bg-black data-[active=true]:border-black" data-active="true" data-ratio="1:1">
                        <span class="w-4 h-4 bg-gray-500 rounded-sm inline-block data-[active=true]:bg-white"></span>
                    </button>
                    <button class="aspect-ratio-btn flex items-center justify-center bg-transparent border border-transparent p-2 rounded-lg text-sm text-text-light hover:border-black/50 data-[active=true]:bg-black data-[active=true]:border-black" data-active="false" data-ratio="3:4">
                        <span class="w-3 h-4 bg-gray-500 rounded-sm inline-block data-[active=true]:bg-white"></span>
                    </button>
                    <button class="aspect-ratio-btn flex items-center justify-center bg-transparent border border-transparent p-2 rounded-lg text-sm text-text-light hover:border-black/50 data-[active=true]:bg-black data-[active=true]:border-black" data-active="false" data-ratio="4:3">
                        <span class="w-4 h-3 bg-gray-500 rounded-sm inline-block data-[active=true]:bg-white"></span>
                    </button>
                    <button class="aspect-ratio-btn flex items-center justify-center bg-transparent border border-transparent p-2 rounded-lg text-sm text-text-light hover:border-black/50 data-[active=true]:bg-black data-[active=true]:border-black" data-active="false" data-ratio="16:9">
                        <span class="w-5 h-3 bg-gray-500 rounded-sm inline-block data-[active=true]:bg-white"></span>
                    </button>
                    <button class="aspect-ratio-btn flex items-center justify-center bg-transparent border border-transparent p-2 rounded-lg text-sm text-text-light hover:border-black/50 data-[active=true]:bg-black data-[active=true]:border-black" data-active="false" data-ratio="9:16">
                        <span class="w-3 h-5 bg-gray-500 rounded-sm inline-block data-[active=true]:bg-white"></span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æŠ˜å æ—¶çš„å°ºå¯¸å›¾æ ‡ -->
        <button id="aspect-ratio-icon-btn" class="v2-sidebar-icon-content w-12 h-12 bg-black/5 rounded-xl cursor-pointer hover:bg-black/10">
            <span class="material-symbols-outlined text-3xl text-black/50">aspect_ratio</span>
        </button>
    </div>

    <!-- æ•°é‡åŒºåŸŸ -->
    <div class="space-y-4">
        <h3 class="text-sm font-semibold v2-sidebar-text v2-sidebar-full-content">æ•°é‡</h3>
        <!-- (å·²ä¿®æ”¹) è¦æ±‚ 3: p-3 -> p-2.5 -->
        <div id="image-count-group" class="grid grid-cols-4 gap-3 v2-sidebar-full-content">
            <button class="image-count-btn flex items-center justify-center p-2.5 rounded-xl bg-white/50 hover:bg-white/80 transition-colors data-[active=true]:bg-black data-[active=true]:text-white data-[active=true]:font-semibold data-[active=true]:ring-2 data-[active=true]:ring-black" data-active="true">1</button>
            <button class="image-count-btn flex items-center justify-center p-2.5 rounded-xl bg-white/50 hover:bg-white/80 transition-colors data-[active=true]:bg-black data-[active=true]:text-white data-[active=true]:font-semibold data-[active=true]:ring-2 data-[active=true]:ring-black" data-active="false">2</button>
            <button class="image-count-btn flex items-center justify-center p-2.5 rounded-xl bg-white/50 hover:bg-white/80 transition-colors data-[active=true]:bg-black data-[active=true]:text-white data-[active=true]:font-semibold data-[active=true]:ring-2 data-[active=true]:ring-black" data-active="false">3</button>
            <button class="image-count-btn flex items-center justify-center p-2.5 rounded-xl bg-white/50 hover:bg-white/80 transition-colors data-[active=true]:bg-black data-[active=true]:text-white data-[active=true]:font-semibold data-[active=true]:ring-2 data-[active=true]:ring-black" data-active="false">4</button>
        </div>
        
        <!-- æŠ˜å æ—¶çš„æ•°é‡å›¾æ ‡ -->
        <button class="v2-sidebar-icon-content w-12 h-12 bg-black/5 rounded-xl cursor-pointer hover:bg-black/10">
            <span class="material-symbols-outlined text-3xl text-black/50">filter_4</span>
        </button>
    </div>
    
    <!-- ç³»åˆ—å›¾å¼€å…³ -->
    <div class="flex items-center justify-between v2-sidebar-full-content v2-hide-on-collapse">
        <span class="text-sm font-semibold v2-sidebar-text">å¼€å¯ç³»åˆ—å›¾</span>
        <button id="series-mode-toggle" aria-checked="false" class="v2-switch-btn relative inline-flex h-7 w-12 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2 bg-black/10" role="switch">
            <span aria-hidden="true" class="v2-switch-dot pointer-events-none inline-block h-6 w-6 transform rounded-full bg-white shadow-lg ring-0 transition duration-200 ease-in-out translate-x-0"></span>
        </button>
    </div>

    <!-- ç§»é™¤å·¦ä¸‹è§’ç”¨æˆ·åŒºåŸŸ -->
    <div class="mt-auto pt-8 border-t border-black/10 v2-sidebar-full-content v2-hide-on-collapse">
        <!-- å†…å®¹å·²åˆ é™¤ -->
    </div>
    
    <!-- æŠ˜å æŒ‰é’® -->
    <button id="sidebar-toggle-btn" class="absolute top-1/2 -right-3.5 -translate-y-1/2 w-7 h-7 bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors z-10">
        <span id="toggle-icon-left" class="material-symbols-outlined text-lg">chevron_left</span>
        <span id="toggle-icon-right" class="material-symbols-outlined text-lg hidden">chevron_right</span>
    </button>
</aside>

<!-- 2. ä¸»å†…å®¹åŒºåŸŸ -->
<main class="flex-1 flex flex-col bg-gray-50 dark:bg-zinc-900">
    <!-- (å·²ä¿®æ”¹) è¦æ±‚ 2: ç§»é™¤ä¸‹è¾¹æ¡†, æ·»åŠ  "è§†é¢‘" å’Œ "æ”¶è—" å›¾æ ‡ -->
    <header class="flex items-center justify-end p-4 h-16 shrink-0 border-b-0 border-gray-200 dark:border-zinc-800">
        <div class="flex items-center gap-6">
            <!-- æ–°å¢å›¾æ ‡ -->
            <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                 <span class="material-symbols-outlined text-xl text-gray-600 dark:text-gray-400">movie</span>
            </button>
            <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                 <span class="material-symbols-outlined text-xl text-gray-600 dark:text-gray-400">favorite</span>
            </button>
            
            <div class="flex items-center gap-2" title="ç²’å­å¸ä½™é¢">
                <span class="material-symbols-outlined text-yellow-400 text-xl !fill-1">monetization_on</span>
                <span class="text-sm font-semibold" data-role="credits-display">-- Credits</span>
            </div>
            <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-sm font-bold text-gray-600 dark:text-gray-300" data-role="user-avatar" title="æœªç™»å½•">?</div>
        </div>
    </header>
    
    <!-- å†…å®¹åŒº -->
    <div class="flex-1 overflow-y-auto p-8 relative">
        <div id="results-container" class="space-y-8 w-full px-4">
            <!-- JS åŠ¨æ€ç”Ÿæˆç»“æœ -->
            <div class="text-center text-gray-400 pt-16">
                <span class="material-symbols-outlined text-6xl">auto_awesome</span>
                <p class="mt-4 text-lg">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡åˆ›ä½œå§</p>
                <p class="text-sm">åœ¨åº•éƒ¨çš„è¾“å…¥æ¡†è¾“å…¥æç¤ºè¯ï¼Œç‚¹å‡»ç®­å¤´å³å¯ç”Ÿæˆã€‚</p>
            </div>
        </div>
        
        <!-- åº•éƒ¨è¾“å…¥æ¡†åŒºåŸŸ (åŠ¨æ€é«˜åº¦) -->
        <div class="sticky bottom-0 mt-8 -mx-8 px-8 py-4 bg-gradient-to-t from-gray-50/80 dark:from-zinc-900/80 to-transparent backdrop-blur-sm">
            <div id="prompt-wrapper" class="relative max-w-4xl mx-auto transition-all duration-300">
                <!-- è¾“å…¥æ¡†æ”¹ä¸ºtextareaæ”¯æŒå¤šè¡Œ -->
                <textarea id="prompt-input" rows="1" class="w-full h-16 pl-6 pr-56 py-4 rounded-full bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 shadow-xl text-base placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition-all duration-300 resize-none overflow-hidden" placeholder="è¾“å…¥æç¤ºè¯..."></textarea>

                <div class="absolute right-3 flex items-center gap-1.5">
                    <!-- æŒ‰é’®å›ºå®šåœ¨å³ä¸Šè§’ -->
                    <button class="w-10 h-10 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-xl">mic</span>
                    </button>
                    <button class="w-10 h-10 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-xl">image</span>
                    </button>
                    <button class="w-10 h-10 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-xl">settings</span>
                    </button>
                    
                    <!-- "AIä¼˜åŒ–" æŒ‰é’® -->
                    <button class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-yellow-400 text-black text-sm font-semibold hover:bg-yellow-500 transition-colors">
                        <span class="material-symbols-outlined text-lg">auto_awesome</span>
                        AIä¼˜åŒ–
                    </button>
                    <!-- å‘é€æŒ‰é’® (rounded-full) -->
                    <button id="generate-btn-bottom" class="w-11 h-11 flex items-center justify-center bg-gray-800 dark:bg-gray-200 text-white dark:text-black rounded-full hover:bg-black dark:hover:bg-white transition-colors">
                        <span class="material-symbols-outlined text-2xl">arrow_upward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- å›¾ç‰‡æŸ¥çœ‹å™¨ -->
<div id="image-viewer" class="v2-app v2-viewer-overlay" style="display: none;">
    <div class="v2-viewer-container">
        <img id="viewer-image" class="v2-viewer-image" src="" alt="é¢„è§ˆå›¾">

        <!-- Loading æŒ‡ç¤ºå™¨ -->
        <div class="v2-viewer-loading" style="display: none;">
            <div class="v2-viewer-loading-spinner"></div>
            <div class="v2-viewer-loading-text">åŠ è½½åŸå›¾ä¸­...</div>
        </div>

        <div class="v2-viewer-controls">
            <button class="v2-viewer-btn" onclick="closeImageViewer()" title="å…³é—­ (ESC)">
                <span class="material-symbols-outlined text-white">close</span>
            </button>
            <button class="v2-viewer-btn" onclick="downloadViewerImage()" title="ä¸‹è½½">
                <span class="material-symbols-outlined text-white">download</span>
            </button>
        </div>
    </div>
</div>
</div>

<!-- å®Œæ•´çš„ JS é€»è¾‘ -->
<script>
    // ç­‰å¾…å­—ä½“åŠ è½½å®Œæˆåå†æ˜¾ç¤ºé¡µé¢ï¼Œé˜²æ­¢FOUC
    if (document.fonts) {
        document.fonts.ready.then(() => {
            document.body.classList.add('loaded');
        });
    } else {
        // é™çº§ï¼š300msåæ˜¾ç¤º
        setTimeout(() => {
            document.body.classList.add('loaded');
        }, 300);
    }

    // ====================================================================================
    // ğŸ”‘ å†å²è®°å½•æ‡’åŠ è½½ç³»ç»Ÿï¼ˆå¤ç”¨æ—§ç‰ˆé€»è¾‘ï¼‰
    // ====================================================================================

    // å…¨å±€çŠ¶æ€
    window.historyLoadingState = {
        loadedTaskIds: new Set(),      // å·²åŠ è½½å›¾ç‰‡çš„ä»»åŠ¡ID
        loadingTaskIds: new Set(),     // æ­£åœ¨åŠ è½½çš„ä»»åŠ¡ID
        observer: null,                 // Intersection Observerå®ä¾‹
        maxConcurrent: 2,               // æœ€å¤§å¹¶å‘åŠ è½½æ•°
        activeLoads: 0                  // å½“å‰å¹¶å‘æ•°
    };

    /**
     * æ˜¾ç¤ºéª¨æ¶å±
     */
    window.showSkeletonCards = function(count) {
        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer) return;

        console.log(`ğŸ¨ æ˜¾ç¤º ${count} ä¸ªéª¨æ¶å±å¡ç‰‡`);

        // ç§»é™¤å ä½æç¤º
        const placeholder = resultsContainer.querySelector('.text-center');
        if (placeholder) placeholder.remove();

        // åˆ›å»ºéª¨æ¶å±å¡ç‰‡
        for (let i = 0; i < count; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'v2-skeleton-card space-y-4';
            skeleton.innerHTML = `
                <div class="v2-skeleton-header"></div>
                <div class="v2-skeleton-prompt"></div>
                <div class="v2-skeleton-images"></div>
                <div class="v2-skeleton-actions"></div>
            `;
            resultsContainer.appendChild(skeleton);
        }
    };

    /**
     * æ¸…é™¤éª¨æ¶å±
     */
    window.clearSkeletonCards = function() {
        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer) return;

        const skeletons = resultsContainer.querySelectorAll('.v2-skeleton-card');
        skeletons.forEach(skeleton => skeleton.remove());
        console.log(`ğŸ—‘ï¸ å·²æ¸…é™¤ ${skeletons.length} ä¸ªéª¨æ¶å±å¡ç‰‡`);
    };

    /**
     * æ¸²æŸ“ä»»åŠ¡å¡ç‰‡ï¼ˆLiteæ¨¡å¼ï¼šåªæ˜¾ç¤ºå ä½ç¬¦ï¼Œä¸åŠ è½½å›¾ç‰‡ï¼‰
     */
    window.renderHistoryTasksLite = function(tasks) {
        if (!tasks || tasks.length === 0) {
            console.log('ğŸ“œ æ— å†å²è®°å½•');
            window.clearSkeletonCards();
            return;
        }

        console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“ä»»åŠ¡å¡ç‰‡ï¼ˆLiteæ¨¡å¼ï¼‰...', tasks.length, 'æ¡');

        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer) {
            console.warn('âš ï¸ results-container å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }

        // æ¸…é™¤éª¨æ¶å±
        window.clearSkeletonCards();

        // æ¸²æŸ“æ¯ä¸ªä»»åŠ¡å¡ç‰‡ï¼ˆåªæœ‰å ä½ç¬¦ï¼‰
        tasks.forEach((task, index) => {
            const taskGroup = document.createElement('div');
            taskGroup.className = 'space-y-4';
            taskGroup.dataset.taskId = task.task_id;
            taskGroup.dataset.originalPrompt = task.prompt || '';
            taskGroup.dataset.aspectRatio = task.aspect_ratio || '1:1';
            taskGroup.dataset.count = task.image_count || 4;
            taskGroup.dataset.seriesMode = task.mode === 'conversation' ? 'true' : 'false';
            taskGroup.dataset.lazyLoad = 'pending'; // æ ‡è®°ä¸ºå¾…åŠ è½½

            // åˆ›å»ºheader
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center';
            const promptDisplay = task.prompt ? (task.prompt.substring(0, 40) + (task.prompt.length > 40 ? '...' : '')) : 'æ— æç¤ºè¯';
            header.innerHTML = `
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    ${promptDisplay}
                </p>
                <div class="relative v2-task-menu-wrapper">
                    <button class="v2-task-menu-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                        <span class="material-symbols-outlined text-base">more_horiz</span>
                    </button>
                    <div class="v2-dropdown-menu">
                        <div class="v2-dropdown-item" data-action="regenerate" title="é‡æ–°ç”Ÿæˆ">
                            <span class="material-symbols-outlined">refresh</span>
                        </div>
                        <div class="v2-dropdown-item" data-action="copy" title="å¤åˆ¶æç¤ºè¯">
                            <span class="material-symbols-outlined">content_copy</span>
                        </div>
                        <div class="v2-dropdown-item" data-action="delete" title="åˆ é™¤ä»»åŠ¡">
                            <span class="material-symbols-outlined">delete</span>
                        </div>
                    </div>
                </div>
            `;

            // åˆ›å»ºå›¾ç‰‡ç½‘æ ¼ï¼ˆåªæ˜¾ç¤ºå ä½ç¬¦ï¼‰
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';

            const imageCount = task.image_count || 4;
            for (let i = 0; i < imageCount; i++) {
                const placeholder = document.createElement('div');
                placeholder.className = 'v2-image-wrapper w-full rounded-lg bg-gray-200 dark:bg-zinc-800 animate-pulse flex items-center justify-center';
                placeholder.setAttribute('data-aspect', task.aspect_ratio || '1:1');
                placeholder.innerHTML = '<span class="material-symbols-outlined text-4xl text-gray-400">image</span>';
                grid.appendChild(placeholder);
            }

            taskGroup.appendChild(header);
            taskGroup.appendChild(grid);
            resultsContainer.appendChild(taskGroup);

            console.log(`  âœ… ä»»åŠ¡ ${index + 1}/${tasks.length}: ${task.task_id} å¡ç‰‡å·²åˆ›å»ºï¼ˆå ä½ç¬¦ï¼‰`);
        });

        console.log('âœ… ä»»åŠ¡å¡ç‰‡æ¸²æŸ“å®Œæˆï¼ˆLiteæ¨¡å¼ï¼‰');
    };

    /**
     * åˆå§‹åŒ–å†å²è®°å½•æ‡’åŠ è½½ï¼ˆIntersection Observerï¼‰
     */
    window.initHistoryLazyLoad = function() {
        console.log('ğŸ” åˆå§‹åŒ–Intersection Observeræ‡’åŠ è½½...');

        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer) {
            console.warn('âš ï¸ results-container å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }

        // åˆ›å»ºIntersection Observer
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const taskGroup = entry.target;
                    const taskId = taskGroup.dataset.taskId;
                    const lazyLoadStatus = taskGroup.dataset.lazyLoad;

                    // å¦‚æœè¿˜æ²¡åŠ è½½ï¼Œä¸”æ²¡æœ‰æ­£åœ¨åŠ è½½
                    if (taskId && lazyLoadStatus === 'pending' &&
                        !window.historyLoadingState.loadedTaskIds.has(taskId) &&
                        !window.historyLoadingState.loadingTaskIds.has(taskId)) {

                        console.log(`ğŸ‘€ ä»»åŠ¡è¿›å…¥è§†å£: ${taskId}ï¼Œå¼€å§‹åŠ è½½å›¾ç‰‡...`);
                        loadTaskImages(taskGroup);
                    }
                }
            });
        }, {
            root: null,
            rootMargin: '100px', // æå‰100pxå¼€å§‹åŠ è½½
            threshold: 0.01
        });

        // è§‚å¯Ÿæ‰€æœ‰å¾…åŠ è½½çš„ä»»åŠ¡å¡ç‰‡
        const taskCards = resultsContainer.querySelectorAll('[data-lazy-load="pending"]');
        taskCards.forEach(card => observer.observe(card));

        window.historyLoadingState.observer = observer;

        console.log(`âœ… Intersection Observerå·²åˆå§‹åŒ–ï¼Œè§‚å¯Ÿ ${taskCards.length} ä¸ªä»»åŠ¡å¡ç‰‡`);
    };

    /**
     * åŠ è½½å•ä¸ªä»»åŠ¡çš„å›¾ç‰‡ï¼ˆå¼‚æ­¥åŠ è½½ï¼‰
     */
    async function loadTaskImages(taskGroup) {
        const taskId = taskGroup.dataset.taskId;
        const aspectRatio = taskGroup.dataset.aspectRatio || '1:1';

        // æ£€æŸ¥å¹¶å‘é™åˆ¶
        while (window.historyLoadingState.activeLoads >= window.historyLoadingState.maxConcurrent) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        // æ ‡è®°ä¸ºåŠ è½½ä¸­
        window.historyLoadingState.loadingTaskIds.add(taskId);
        window.historyLoadingState.activeLoads++;
        taskGroup.dataset.lazyLoad = 'loading';

        try {
            console.log(`ğŸ–¼ï¸ å¼€å§‹åŠ è½½ä»»åŠ¡å›¾ç‰‡: ${taskId}`);

            // è°ƒç”¨APIåŠ è½½å›¾ç‰‡
            const detail = await window.V2App.history.getTaskDetail(taskId);

            if (detail && detail.task && detail.task.generated_images) {
                let images = [];

                // è§£æå›¾ç‰‡æ•°æ®
                if (typeof detail.task.generated_images === 'string') {
                    try {
                        images = JSON.parse(detail.task.generated_images);
                    } catch (e) {
                        console.error('  âŒ è§£æå›¾ç‰‡æ•°æ®å¤±è´¥:', e);
                    }
                } else if (Array.isArray(detail.task.generated_images)) {
                    images = detail.task.generated_images;
                }

                if (images.length > 0) {
                    console.log(`  âœ… å·²åŠ è½½ ${images.length} å¼ å›¾ç‰‡`);

                    // æ¸²æŸ“å›¾ç‰‡
                    const grid = taskGroup.querySelector('.grid');
                    if (grid) {
                        grid.innerHTML = ''; // æ¸…ç©ºå ä½ç¬¦

                        images.forEach((imageData, index) => {
                            let imageUrl = '';

                            if (typeof imageData === 'string') {
                                imageUrl = imageData;
                            } else if (imageData && imageData.url) {
                                imageUrl = imageData.url;
                            } else if (imageData && imageData.thumbnail_url) {
                                imageUrl = imageData.thumbnail_url;
                            } else if (imageData && imageData.b64_json) {
                                imageUrl = `data:image/png;base64,${imageData.b64_json}`;
                            }

                            if (!imageUrl) return;

                            const imageWrapper = document.createElement('div');
                            imageWrapper.className = 'v2-image-wrapper relative group w-full rounded-xl flex-shrink-0 overflow-hidden bg-gray-100';
                            imageWrapper.setAttribute('data-aspect', aspectRatio);

                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.alt = `ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}`;
                            img.className = 'w-full h-full object-cover';

                            const overlay = document.createElement('div');
                            overlay.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center gap-4 opacity-0 group-hover:opacity-100';
                            overlay.innerHTML = `
                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                    data-action="view"
                                    onclick="openImageWithOriginal('${taskId}', ${index}, '${imageUrl}')">
                                    visibility
                                </span>
                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                    data-action="edit"
                                    onclick="showInfo('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­')">
                                    edit
                                </span>
                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                    data-action="video"
                                    onclick="showInfo('è§†é¢‘åŠŸèƒ½å¼€å‘ä¸­')">
                                    movie
                                </span>
                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                    data-action="favorite"
                                    onclick="showInfo('æ”¶è—åŠŸèƒ½å¼€å‘ä¸­')">
                                    favorite
                                </span>
                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                    data-action="download"
                                    onclick="window.location.href='${imageUrl}'">
                                    download
                                </span>
                            `;

                            imageWrapper.appendChild(img);
                            imageWrapper.appendChild(overlay);
                            grid.appendChild(imageWrapper);
                        });

                        // æ ‡è®°ä¸ºå·²åŠ è½½
                        taskGroup.dataset.lazyLoad = 'loaded';
                        window.historyLoadingState.loadedTaskIds.add(taskId);
                    }
                } else {
                    console.log(`  âš ï¸ ä»»åŠ¡ ${taskId} æ²¡æœ‰å›¾ç‰‡`);
                    taskGroup.dataset.lazyLoad = 'empty';
                }
            }
        } catch (error) {
            console.error(`  âŒ åŠ è½½ä»»åŠ¡ ${taskId} çš„å›¾ç‰‡å¤±è´¥:`, error);
            taskGroup.dataset.lazyLoad = 'error';
        } finally {
            // é‡Šæ”¾å¹¶å‘æ§½ä½
            window.historyLoadingState.loadingTaskIds.delete(taskId);
            window.historyLoadingState.activeLoads--;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {

        // --- å ä½æç¤ºå‡½æ•° ---
        function showComingSoon(featureName) {
            showInfo(`${featureName} åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼`);
        }

        // --- Toastæç¤ºç³»ç»Ÿ ---
        function showToast(message, type = 'info', duration = 3000) {
            // ç§»é™¤æ—§çš„Toastï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldToast = document.querySelector('.v2-toast');
            if (oldToast) {
                oldToast.remove();
            }

            // åˆ›å»ºToastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `v2-toast ${type}`;

            // å›¾æ ‡æ˜ å°„
            const icons = {
                success: 'check_circle',
                error: 'cancel',
                warning: 'warning',
                info: 'info'
            };

            toast.innerHTML = `
                <span class="material-symbols-outlined">${icons[type] || 'info'}</span>
                <span>${message}</span>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'v2-slideOut 0.3s ease-out';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, duration);
        }

        // Toastå¿«æ·æ–¹æ³•
        window.showToast = showToast;
        window.showSuccess = (msg, duration) => showToast(msg, 'success', duration);
        window.showError = (msg, duration) => showToast(msg, 'error', duration);
        window.showWarning = (msg, duration) => showToast(msg, 'warning', duration);
        window.showInfo = (msg, duration) => showToast(msg, 'info', duration);

        // --- å›¾ç‰‡æŸ¥çœ‹å™¨ï¼ˆå¢å¼ºç‰ˆï¼Œæ”¯æŒç¼©ç•¥å›¾â†’åŸå›¾åŠ è½½ï¼‰ ---
        window.openImageViewer = function(imageSrc, options = {}) {
            const viewer = document.getElementById('image-viewer');
            const viewerImage = document.getElementById('viewer-image');
            const viewerLoading = viewer.querySelector('.v2-viewer-loading');

            if (!viewer || !viewerImage) return;

            const { isLoading = false } = options;

            // é‡ç½®
            viewerImage.src = imageSrc;
            viewer.style.display = 'flex';

            // è®¾ç½®loadingçŠ¶æ€
            if (viewerLoading) {
                viewerLoading.style.display = isLoading ? 'flex' : 'none';
            }
            if (isLoading) {
                viewerImage.style.opacity = '0.5';
            } else {
                viewerImage.style.opacity = '1';
            }

            // ç¦æ­¢bodyæ»šåŠ¨
            document.body.style.overflow = 'hidden';
        };

        window.updateImageViewer = function(newImageSrc) {
            const viewerImage = document.getElementById('viewer-image');
            const viewer = document.getElementById('image-viewer');
            const viewerLoading = viewer ? viewer.querySelector('.v2-viewer-loading') : null;

            if (!viewerImage) return;

            viewerImage.src = newImageSrc;
            viewerImage.style.opacity = '1';

            // éšè—loading
            if (viewerLoading) {
                viewerLoading.style.display = 'none';
            }
        };

        window.closeImageViewer = function() {
            const viewer = document.getElementById('image-viewer');
            viewer.style.display = 'none';

            // æ¢å¤bodyæ»šåŠ¨
            document.body.style.overflow = '';
        };

        // æ‰“å¼€å›¾ç‰‡å¹¶åŠ è½½åŸå›¾ï¼ˆå®Œå…¨å¤ç”¨æ—§ç‰ˆé€»è¾‘ï¼‰
        window.openImageWithOriginal = async function(taskId, imageIndex, thumbnailUrl) {
            try {
                // 1. å…ˆç”¨ç¼©ç•¥å›¾æ‰“å¼€æŸ¥çœ‹å™¨ï¼Œæ˜¾ç¤ºloading
                window.openImageViewer(thumbnailUrl, { isLoading: true });

                // 2. è°ƒç”¨APIè·å–åŸå›¾
                console.log(`ğŸ” åŠ è½½ä»»åŠ¡ ${taskId} çš„åŸå›¾...`);
                const result = await window.V2App.history.loadFullImages(taskId);

                // 3. è§£æåŸå›¾URL
                if (result && result.task && result.task.generated_images) {
                    const images = result.task.generated_images;
                    if (Array.isArray(images) && images[imageIndex]) {
                        const imageData = images[imageIndex];
                        let fullUrl = '';

                        // è§£æå›¾ç‰‡URL
                        if (typeof imageData === 'string') {
                            fullUrl = imageData;
                        } else if (imageData && imageData.url) {
                            fullUrl = imageData.url;
                        } else if (imageData && imageData.b64_json) {
                            fullUrl = `data:image/png;base64,${imageData.b64_json}`;
                        }

                        // 4. æ›¿æ¢æˆåŸå›¾
                        if (fullUrl) {
                            console.log(`âœ… åŸå›¾åŠ è½½æˆåŠŸ`);
                            window.updateImageViewer(fullUrl);
                        } else {
                            console.warn('âš ï¸  åŸå›¾URLä¸ºç©º');
                            window.updateImageViewer(thumbnailUrl);
                        }
                    } else {
                        console.warn('âš ï¸  åŸå›¾ç´¢å¼•è¶Šç•Œ');
                        window.updateImageViewer(thumbnailUrl);
                    }
                } else {
                    console.warn('âš ï¸  åŸå›¾æ•°æ®æ ¼å¼é”™è¯¯');
                    window.updateImageViewer(thumbnailUrl);
                }
            } catch (error) {
                console.error(`âŒ åŠ è½½ä»»åŠ¡ ${taskId} åŸå›¾å¤±è´¥:`, error);
                // å¤±è´¥æ—¶è‡³å°‘æ˜¾ç¤ºç¼©ç•¥å›¾
                window.updateImageViewer(thumbnailUrl);
            }
        };

        window.downloadViewerImage = function() {
            const viewerImage = document.getElementById('viewer-image');
            const link = document.createElement('a');
            link.href = viewerImage.src;
            link.download = `aiimage_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showSuccess('å›¾ç‰‡å·²å¼€å§‹ä¸‹è½½');
        };

        // ESCé”®å…³é—­æŸ¥çœ‹å™¨
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const viewer = document.getElementById('image-viewer');
                if (viewer.style.display === 'flex') {
                    closeImageViewer();
                }
            }
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­æŸ¥çœ‹å™¨
        document.getElementById('image-viewer')?.addEventListener('click', (e) => {
            if (e.target.id === 'image-viewer') {
                closeImageViewer();
            }
        });


        // --- æŒ‰é’®ç»„é€šç”¨é€»è¾‘ ---
        function setupButtonGroup(groupId, isDropdownItem = false) {
            const group = document.getElementById(groupId);
            if (!group) return;

            group.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                group.querySelectorAll('button').forEach(btn => {
                    btn.dataset.active = 'false';
                    if (btn.classList.contains('image-count-btn')) {
                         btn.classList.remove('bg-black', 'text-white', 'font-semibold', 'ring-2', 'ring-black');
                         btn.classList.add('bg-white/50', 'hover:bg-white/80');
                    }
                    if (btn.classList.contains('aspect-ratio-btn')) {
                        btn.classList.remove('bg-black', 'border-black');
                        btn.querySelector('span')?.classList.remove('bg-white');
                        btn.querySelector('span')?.classList.add('bg-gray-500');
                    }
                });
                
                button.dataset.active = 'true';
                if (button.classList.contains('image-count-btn')) {
                    button.classList.add('bg-black', 'text-white', 'font-semibold', 'ring-2', 'ring-black');
                    button.classList.remove('bg-white/50', 'hover:bg-white/80');
                }
                if (button.classList.contains('aspect-ratio-btn')) {
                    button.classList.add('bg-black', 'border-black');
                    button.querySelector('span')?.classList.add('bg-white');
                    button.querySelector('span')?.classList.remove('bg-gray-500');
                }

                if (isDropdownItem) {
                    const wrapper = group.closest('#aspect-ratio-wrapper');
                    const displaySpan = wrapper.querySelector('#current-aspect-ratio-display');
                    const dropdown = wrapper.querySelector('#aspect-ratio-dropdown');
                    
                    const ratioText = button.dataset.ratio;
                    let iconHTML = '';
                    if (ratioText === '1:1') iconHTML = '<span class="w-4 h-4 bg-gray-600 rounded-sm inline-block"></span>';
                    else if (ratioText === '16:9') iconHTML = '<span class="w-5 h-3 bg-gray-600 rounded-sm inline-block"></span>';
                    else if (ratioText === '3:4') iconHTML = '<span class="w-3 h-4 bg-gray-600 rounded-sm inline-block"></span>';
                    else if (ratioText === '4:3') iconHTML = '<span class="w-4 h-3 bg-gray-600 rounded-sm inline-block"></span>';
                    else if (ratioText === '9:16') iconHTML = '<span class="w-3 h-5 bg-gray-600 rounded-sm inline-block"></span>';

                    displaySpan.innerHTML = `${iconHTML} <span class="font-medium v2-sidebar-text">${ratioText}</span>`;
                    dropdown.classList.add('hidden');
                }
            });
        }

        // 1. è®¾ç½®æ•°é‡æŒ‰é’®ç»„
        setupButtonGroup('image-count-group');
        
        // 2. è®¾ç½®å°ºå¯¸ä¸‹æ‹‰èœå•
        const aspectRatioBtn = document.getElementById('current-aspect-ratio-btn');
        const aspectRatioDropdown = document.getElementById('aspect-ratio-dropdown');
        const aspectRatioIconBtn = document.getElementById('aspect-ratio-icon-btn');
        
        aspectRatioBtn.addEventListener('click', () => {
            aspectRatioDropdown.classList.toggle('hidden');
        });
        aspectRatioIconBtn.addEventListener('click', () => {
             document.getElementById('sidebar-toggle-btn').click();
             setTimeout(() => {
                aspectRatioBtn.click();
             }, 300);
        });
        setupButtonGroup('aspect-ratio-group', true);

        // 3. åŠ¨æ€ç”Ÿæˆç»“æœ
        const generateBtnBottom = document.getElementById('generate-btn-bottom');
        const resultsContainer = document.getElementById('results-container');
        const promptInput = document.getElementById('prompt-input');

        // 3.5 AIæç¤ºè¯ä¼˜åŒ–åŠŸèƒ½
        const handleOptimizePrompt = async () => {
            const promptText = promptInput.value.trim();

            if (!promptText) {
                showWarning('è¯·å…ˆè¾“å…¥æç¤ºè¯');
                return;
            }

            // è·å–å½“å‰å‚æ•°
            const ratioBtn = document.querySelector('#aspect-ratio-group button[data-active="true"]');
            const aspectRatio = ratioBtn ? ratioBtn.dataset.ratio : '1:1';
            const seriesMode = seriesToggle.getAttribute('aria-checked') === 'true';

            // åˆ¤æ–­æ¨¡å¼
            let mode = 'text-to-image';
            if (uploadedImages.size > 0) {
                mode = seriesMode ? 'conversation' : 'image-to-image';
            } else if (seriesMode) {
                mode = 'conversation';
            }

            try {
                console.log('âœ¨ å¼€å§‹ä¼˜åŒ–æç¤ºè¯...');
                showInfo('æ­£åœ¨ä¼˜åŒ–æç¤ºè¯...', 2000);

                const result = await window.V2App.handleOptimizePrompt({
                    prompt: promptText,
                    mode: mode,
                    aspectRatio: aspectRatio
                });

                if (result.success && result.data.optimized_prompt) {
                    promptInput.value = result.data.optimized_prompt;
                    console.log('âœ… æç¤ºè¯ä¼˜åŒ–æˆåŠŸï¼');
                    showSuccess('æç¤ºè¯å·²ä¼˜åŒ–ï¼');
                } else {
                    console.error('âŒ ä¼˜åŒ–å¤±è´¥:', result.message);
                    showError('ä¼˜åŒ–å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('âŒ ä¼˜åŒ–å¼‚å¸¸:', error);
                showError('ä¼˜åŒ–å¤±è´¥: ' + error.message);
            }
        };

        generateBtnBottom.addEventListener('click', async () => {
            const promptText = promptInput.value.trim();

            // éªŒè¯è¾“å…¥
            if (!promptText) {
                showWarning('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }

            // ç§»é™¤å ä½æç¤º
            const placeholder = resultsContainer.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }

            // è·å–å½“å‰é€‰æ‹©çš„å‚æ•°
            const countBtn = document.querySelector('#image-count-group button[data-active="true"]');
            const count = countBtn ? parseInt(countBtn.textContent) : 1;

            const ratioBtn = document.querySelector('#aspect-ratio-group button[data-active="true"]');
            const aspectRatio = ratioBtn ? ratioBtn.dataset.ratio : '1:1';

            const seriesMode = seriesToggle.getAttribute('aria-checked') === 'true';

            // åˆ›å»ºåŠ è½½ä¸­çš„ä»»åŠ¡å¡ç‰‡
            const newResultGroup = document.createElement('div');
            newResultGroup.className = 'space-y-4';
            // ğŸ”‘ ä¿å­˜åŸå§‹æç¤ºè¯åˆ°dataå±æ€§ï¼Œç”¨äºå¤åˆ¶å’Œå†æ¬¡ç”Ÿæˆ
            newResultGroup.dataset.originalPrompt = promptText;
            newResultGroup.dataset.aspectRatio = aspectRatio;
            newResultGroup.dataset.count = count;
            newResultGroup.dataset.seriesMode = seriesMode;
            // ğŸ”‘ ä¿å­˜æ˜¯å¦æœ‰å‚è€ƒå›¾ç‰‡çš„æ ‡è®°ï¼ˆç”¨äºé‡æ–°ç”Ÿæˆæ—¶æ¢å¤å›¾ç‰‡ï¼‰
            newResultGroup.dataset.hasReferenceImages = (uploadedImages.size > 0) ? 'true' : 'false';

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center';
            header.innerHTML = `
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    ${promptText.substring(0, 40)}${promptText.length > 40 ? '...' : ''}
                </p>
                <div class="relative v2-task-menu-wrapper">
                    <button class="v2-task-menu-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                        <span class="material-symbols-outlined text-base">more_horiz</span>
                    </button>
                    <div class="v2-dropdown-menu">
                        <div class="v2-dropdown-item" data-action="regenerate" title="é‡æ–°ç”Ÿæˆ">
                            <span class="material-symbols-outlined">refresh</span>
                        </div>
                        <div class="v2-dropdown-item" data-action="copy" title="å¤åˆ¶æç¤ºè¯">
                            <span class="material-symbols-outlined">content_copy</span>
                        </div>
                        <div class="v2-dropdown-item" data-action="delete" title="åˆ é™¤ä»»åŠ¡">
                            <span class="material-symbols-outlined">delete</span>
                        </div>
                    </div>
                </div>
            `;

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';

            // æ˜¾ç¤ºåŠ è½½å ä½ç¬¦
            for (let i = 0; i < count; i++) {
                const loadingPlaceholder = document.createElement('div');
                // âš ï¸ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ v2-image-wrapper ç±»å’Œ data-aspect å±æ€§ï¼ˆå¤ç”¨æ—§ç‰ˆé€»è¾‘ï¼‰
                loadingPlaceholder.className = 'v2-image-wrapper w-full rounded-lg bg-gray-200 dark:bg-zinc-800 animate-pulse flex items-center justify-center';
                loadingPlaceholder.setAttribute('data-aspect', aspectRatio);  // ğŸ”‘ æ ¹æ®å®é™…å°ºå¯¸è®¾ç½®
                loadingPlaceholder.innerHTML = '<span class="material-symbols-outlined text-4xl text-gray-400">image</span>';
                grid.appendChild(loadingPlaceholder);
            }

            newResultGroup.appendChild(header);
            newResultGroup.appendChild(grid);
            resultsContainer.insertBefore(newResultGroup, resultsContainer.firstChild);

            // ğŸ”‘ ä¿®å¤ï¼šä¸æ»‘æ»šåŠ¨åˆ°æ–°åˆ›å»ºçš„ä»»åŠ¡ï¼Œç»™ç”¨æˆ·åé¦ˆ
            setTimeout(() => {
                newResultGroup.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);

            // è°ƒç”¨ V2App.handleGenerate() - æ·»åŠ æµå¼æ›´æ–°å›è°ƒ
            try {
                console.log('ğŸ¨ V2 å¼€å§‹ç”Ÿæˆå›¾ç‰‡...', {
                    prompt: promptText,
                    count: count,
                    aspectRatio: aspectRatio,
                    seriesMode: seriesMode,
                    uploadedImagesCount: uploadedImages.size
                });

                const result = await window.V2App.handleGenerate({
                    prompt: promptText,
                    uploadedImages: uploadedImages,
                    count: count,
                    aspectRatio: aspectRatio,
                    seriesMode: seriesMode,
                    // ğŸ”‘ æµå¼æ›´æ–°å›è°ƒï¼šæ¯å®Œæˆä¸€å¼ å°±æ˜¾ç¤º
                    onProgress: (progress) => {
                        console.log('ğŸ“Š ç”Ÿæˆè¿›åº¦:', progress);

                        // ğŸ”‘ ä¿®å¤ç³»åˆ—å›¾æ¸²æŸ“ï¼šåŒæ—¶å¤„ç† 'processing' å’Œ 'completed' çŠ¶æ€
                        if ((progress.status === 'processing' || progress.status === 'completed') && progress.images && progress.images.length > 0) {
                            // æ¸…ç©ºgridå¹¶é‡æ–°æ¸²æŸ“æ‰€æœ‰å·²å®Œæˆçš„å›¾ç‰‡
                            grid.innerHTML = '';

                            // æ¸²æŸ“å·²å®Œæˆçš„å›¾ç‰‡
                            progress.images.forEach((imageData, index) => {
                                const imageWrapper = document.createElement('div');
                                imageWrapper.className = 'v2-image-wrapper relative group w-full rounded-xl flex-shrink-0 overflow-hidden bg-gray-100';
                                imageWrapper.setAttribute('data-aspect', aspectRatio);

                                const img = document.createElement('img');
                                img.src = imageData.url || imageData.thumbnail_url;
                                img.className = 'w-full h-full object-cover';
                                img.alt = `ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}`;

                                const overlay = document.createElement('div');
                                overlay.className = 'absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-3';
                                overlay.innerHTML = `
                                    <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-110 p-2" data-action="view" title="æŸ¥çœ‹å¤§å›¾">visibility</span>
                                    <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-110 p-2" data-action="edit" title="ä¿®æ”¹å›¾ç‰‡">edit</span>
                                    <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-110 p-2" data-action="video" title="è½¬è§†é¢‘">movie</span>
                                    <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-110 p-2" data-action="favorite" title="æ”¶è—">favorite</span>
                                    <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-110 p-2" data-action="download" title="ä¸‹è½½">download</span>
                                `;

                                // æ·»åŠ äº‹ä»¶ç›‘å¬
                                overlay.addEventListener('click', (e) => {
                                    const action = e.target.closest('[data-action]')?.dataset.action;
                                    if (action === 'view') {
                                        openImageViewer(imageData.url || imageData.thumbnail_url);
                                    } else if (action === 'download') {
                                        const link = document.createElement('a');
                                        link.href = imageData.url || imageData.thumbnail_url;
                                        link.download = `aiimage_${Date.now()}_${index + 1}.png`;
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                        showSuccess('å›¾ç‰‡å·²å¼€å§‹ä¸‹è½½');
                                    } else if (action === 'edit') {
                                        showInfo('ç¼–è¾‘å›¾ç‰‡åŠŸèƒ½å¼€å‘ä¸­');
                                    } else if (action === 'video') {
                                        showInfo('è½¬è§†é¢‘åŠŸèƒ½å¼€å‘ä¸­');
                                    } else if (action === 'favorite') {
                                        showInfo('æ”¶è—åŠŸèƒ½å¼€å‘ä¸­');
                                    }
                                });

                                imageWrapper.appendChild(img);
                                imageWrapper.appendChild(overlay);
                                grid.appendChild(imageWrapper);
                            });

                            // æ·»åŠ å‰©ä½™çš„å ä½ç¬¦
                            const remainingCount = progress.total - progress.images.length;
                            for (let i = 0; i < remainingCount; i++) {
                                const loadingPlaceholder = document.createElement('div');
                                loadingPlaceholder.className = 'v2-image-wrapper w-full rounded-lg bg-gray-200 dark:bg-zinc-800 animate-pulse flex items-center justify-center';
                                loadingPlaceholder.setAttribute('data-aspect', aspectRatio);
                                loadingPlaceholder.innerHTML = '<span class="material-symbols-outlined text-4xl text-gray-400">image</span>';
                                grid.appendChild(loadingPlaceholder);
                            }
                        }
                    }
                });

                console.log('ğŸ“¦ V2 APIè¿”å›æ•°æ®:', result);

                if (result.success && result.data && result.data.images && result.data.images.length > 0) {
                    console.log('âœ… V2 ç”ŸæˆæˆåŠŸï¼æœ€ç»ˆ', result.data.images.length, 'å¼ å›¾ç‰‡');

                    // ğŸ”‘ ä¿å­˜task_idåˆ°datasetï¼Œç”¨äºåˆ é™¤æ“ä½œ
                    if (result.data.task_id) {
                        newResultGroup.dataset.taskId = result.data.task_id;
                    }

                    // ğŸ”‘ æµå¼æ˜¾ç¤ºå·²ç»æ¸²æŸ“äº†æ‰€æœ‰å›¾ç‰‡ï¼Œè¿™é‡Œåªéœ€æ˜¾ç¤ºToastæç¤º

                    // æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€Toast
                    const successCount = result.data.success_count || result.data.images.length;
                    const failedCount = result.data.failed_count || 0;

                    if (failedCount > 0) {
                        showWarning(`ç”Ÿæˆå®Œæˆï¼šæˆåŠŸ ${successCount} å¼ ï¼Œå¤±è´¥ ${failedCount} å¼ `);
                    } else {
                        showSuccess(`æˆåŠŸç”Ÿæˆ ${successCount} å¼ å›¾ç‰‡ï¼`);
                    }

                    // æ¸…ç©ºè¾“å…¥æ¡†
                    promptInput.value = '';
                } else {
                    // ç”Ÿæˆå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯
                    console.error('âŒ V2 ç”Ÿæˆå¤±è´¥ï¼Œæ•°æ®ç»“æ„:', result);

                    // ğŸ”‘ ç‰¹æ®Šå¤„ç†ï¼š504è¶…æ—¶é”™è¯¯ï¼ˆç³»åˆ—å›¾å¯èƒ½æ­£åœ¨åå°å¤„ç†ï¼‰
                    if (result.message === 'TIMEOUT_504') {
                        grid.innerHTML = `
                            <div class="col-span-full text-center p-4">
                                <span class="material-symbols-outlined text-6xl text-yellow-500">schedule</span>
                                <div class="text-yellow-600 dark:text-yellow-400 mt-4 font-medium">
                                    â±ï¸ å›¾ç‰‡ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œæ­£åœ¨åå°å¤„ç†ä¸­
                                </div>
                                <div class="text-sm mt-2 text-gray-600 dark:text-gray-400">
                                    è¯·ç¨ååˆ·æ–°é¡µé¢æŸ¥çœ‹å†å²è®°å½•
                                </div>
                                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-black rounded-lg transition-colors">
                                    åˆ·æ–°é¡µé¢
                                </button>
                            </div>
                        `;
                        showWarning(result.userMessage || 'å›¾ç‰‡ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œæ­£åœ¨åå°å¤„ç†ä¸­ã€‚è¯·ç¨ååˆ·æ–°é¡µé¢æŸ¥çœ‹å†å²è®°å½•ã€‚', 6000);
                    } else {
                        // å…¶ä»–é”™è¯¯
                        grid.innerHTML = `
                            <div class="col-span-full text-center text-red-500 p-4">
                                âŒ ${result.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•'}
                                <div class="text-xs mt-2 text-gray-500">è¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
                            </div>
                        `;
                        showError(result.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }
            } catch (error) {
                // æ•è·å¼‚å¸¸
                console.error('âŒ V2 ç”Ÿæˆå¼‚å¸¸:', error);
                console.error('âŒ V2 å¼‚å¸¸å †æ ˆ:', error.stack);
                grid.innerHTML = `
                    <div class="col-span-full text-center text-red-500 p-4">
                        âŒ ç”Ÿæˆå‡ºé”™: ${error.message}
                        <div class="text-xs mt-2 text-gray-500">è¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
                    </div>
                `;
            }
        });

        // 4. åŠ¨æ€æ·»åŠ ä¸Šä¼ æ¡†ï¼ˆé™åˆ¶7å¼ ï¼š1ä¸»å›¾ + 6é™„åŠ ï¼‰
        const addUploadRowBtn = document.getElementById('add-upload-row-btn');
        const additionalUploadsContainer = document.getElementById('additional-uploads-container');
        const uploadRows = new Map(); // å­˜å‚¨è¡ŒIDå’Œå…ƒç´ çš„æ˜ å°„
        let rowIdCounter = 0; // è¡ŒIDè®¡æ•°å™¨
        const maxUploadRows = 3; // 3è¡Œ x 2å¼  = 6å¼ é™„åŠ 

        addUploadRowBtn.addEventListener('click', () => {
            if (uploadRows.size >= maxUploadRows) {
                showWarning('æœ€å¤šåªèƒ½ä¸Šä¼ 7å¼ å›¾ç‰‡ï¼ˆ1å¼ ä¸»å›¾ + 6å¼ é™„åŠ å›¾ï¼‰');
                return;
            }

            const rowId = `row_${rowIdCounter++}`; // å”¯ä¸€è¡ŒID
            const newRow = document.createElement('div');
            newRow.className = 'grid grid-cols-2 gap-2';
            newRow.dataset.rowId = rowId;

            const picIndex1 = uploadRows.size * 2 + 1;
            const picIndex2 = picIndex1 + 1;

            newRow.innerHTML = `
                <div class="v2-upload-label-wrapper">
                    <label for="ref-img-${rowId}-1" data-slot="${rowId}-1" class="flex flex-col items-center justify-center w-full aspect-square border-2 border-dashed border-black/20 rounded-xl bg-black/5 v2-pattern-bg cursor-pointer hover:border-black/40">
                        <span class="material-symbols-outlined text-3xl text-black/30">add_photo_alternate</span>
                    </label>
                    <div class="v2-upload-empty-delete" data-row-id="${rowId}">
                        <span class="material-symbols-outlined" style="font-size: 16px;">close</span>
                    </div>
                    <input id="ref-img-${rowId}-1" type="file" class="sr-only">
                </div>
                <div class="v2-upload-label-wrapper">
                    <label for="ref-img-${rowId}-2" data-slot="${rowId}-2" class="flex flex-col items-center justify-center w-full aspect-square border-2 border-dashed border-black/20 rounded-xl bg-black/5 v2-pattern-bg cursor-pointer hover:border-black/40">
                        <span class="material-symbols-outlined text-3xl text-black/30">add_photo_alternate</span>
                    </label>
                    <div class="v2-upload-empty-delete" data-row-id="${rowId}">
                        <span class="material-symbols-outlined" style="font-size: 16px;">close</span>
                    </div>
                    <input id="ref-img-${rowId}-2" type="file" class="sr-only">
                </div>
            `;
            
            additionalUploadsContainer.appendChild(newRow);
            uploadRows.set(rowId, newRow); // å­˜å‚¨æ˜ å°„
            newRow.querySelectorAll('label').forEach(label => cacheLabelDefault(label));

            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const deleteButtons = newRow.querySelectorAll('.v2-upload-empty-delete');
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const rowIdToDelete = btn.dataset.rowId;
                    const rowElement = uploadRows.get(rowIdToDelete);
                    if (rowElement) {
                        const labels = rowElement.querySelectorAll('label');
                        labels.forEach(label => detachLabelImage(label));
                        rowElement.remove();
                        uploadRows.delete(rowIdToDelete); // ä»Mapä¸­åˆ é™¤
                        // æ¢å¤æ·»åŠ æŒ‰é’®
                        addUploadRowBtn.disabled = false;
                        addUploadRowBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
            });

            // ç»‘å®šä¸Šä¼ æ¡†çš„inputäº‹ä»¶
            const inputs = newRow.querySelectorAll('input[type="file"]');
            inputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        // æ‰¾åˆ°å¯¹åº”çš„labelï¼ˆinputçš„çˆ¶å…ƒç´ çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ ï¼‰
                        const wrapper = input.parentElement;
                        const label = wrapper.querySelector('label');
                        handleImageUpload(e.target.files[0], label);
                        e.target.value = '';
                    }
                });
            });

            if (uploadRows.size >= maxUploadRows) {
                addUploadRowBtn.disabled = true;
                addUploadRowBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        });

        // 5. ä¾§è¾¹æ æŠ˜å åŠŸèƒ½ï¼ˆé‡æ„ç‰ˆï¼‰
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const iconLeft = document.getElementById('toggle-icon-left');
        const iconRight = document.getElementById('toggle-icon-right');
        const promptWrapper = document.getElementById('prompt-wrapper');
        // promptInput å·²åœ¨ä¸Šæ–¹ç¬¬320è¡Œå£°æ˜ï¼Œæ­¤å¤„å¤ç”¨

        // æŠ˜å /å±•å¼€å‡½æ•°
        function toggleSidebar() {
            const isCollapsed = sidebar.classList.contains('w-20');

            // ğŸ”‘ ä¿®å¤1: æ·»åŠ transitioningç±»ä»¥è§£å†³å†…å®¹é—ªçƒé—®é¢˜
            sidebar.classList.add('transitioning');
            sidebar.classList.toggle('is-collapsed');

            if (isCollapsed) {
                // --- å±•å¼€ ---
                sidebar.classList.remove('w-20', 'p-4');
                sidebar.classList.add('w-[340px]', 'p-6');
                iconLeft.classList.remove('hidden');
                iconRight.classList.add('hidden');

                // ğŸ”‘ ä¿®å¤2: ç§»é™¤æŒ‰é’®ä½ç½®JSï¼ˆCSSå·²é€šè¿‡fixedå®šä½å¤„ç†ï¼‰
                // toggleBtn.classList.remove('left-3.5');
                // toggleBtn.classList.add('-right-3.5');

                // å±•å¼€æ—¶ï¼šæ¢å¤é»˜è®¤å•è¡Œï¼Œrounded-full
                promptInput.classList.remove('h-40', 'rounded-3xl');
                promptInput.classList.add('h-16', 'rounded-full');
                promptInput.rows = 1;
                promptInput.style.height = 'auto';

                // æ¢å¤prompt wrapperæœ€å¤§å®½åº¦
                promptWrapper.classList.remove('max-w-6xl');
                promptWrapper.classList.add('max-w-4xl');
            } else {
                // --- æŠ˜å  ---
                sidebar.classList.add('w-20', 'p-4');
                sidebar.classList.remove('w-[340px]', 'p-6');
                iconLeft.classList.add('hidden');
                iconRight.classList.remove('hidden');

                // ğŸ”‘ ä¿®å¤2: ç§»é™¤æŒ‰é’®ä½ç½®JSï¼ˆCSSå·²é€šè¿‡fixedå®šä½å¤„ç†ï¼‰
                // toggleBtn.classList.remove('-right-3.5');
                // toggleBtn.classList.add('left-3.5');

                // æŠ˜å æ—¶ï¼šçœŸæ­£å¢åŠ textareaé«˜åº¦ï¼ˆ5è¡Œï¼Œé€‚ä¸­åœ†è§’ï¼‰
                promptInput.classList.remove('h-16', 'rounded-full');
                promptInput.classList.add('h-40', 'rounded-3xl');
                promptInput.rows = 5;
                promptInput.style.height = '10rem'; // h-40 = 10rem

                // æ‰©å¤§prompt wrapperæœ€å¤§å®½åº¦
                promptWrapper.classList.remove('max-w-4xl');
                promptWrapper.classList.add('max-w-6xl');

                // ğŸ”‘ ä¿®å¤3: æ›´æ–°æŠ˜å æ—¶çš„ç¼©ç•¥å›¾å®¹å™¨
                updateCollapsedThumbnails();
            }

            // ğŸ”‘ ä¿®å¤1: è¿‡æ¸¡åŠ¨ç”»å®Œæˆåç§»é™¤transitioningç±»
            setTimeout(() => {
                sidebar.classList.remove('transitioning');
            }, 300);
        }

        // ğŸ”‘ ä¿®å¤3: æ›´æ–°æŠ˜å æ—¶çš„ç¼©ç•¥å›¾å®¹å™¨
        function updateCollapsedThumbnails() {
            const container = document.getElementById('collapsed-thumbnails-container');
            if (!container) return;

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // å¦‚æœæ²¡æœ‰ä¸Šä¼ çš„å›¾ç‰‡ï¼Œä¸æ˜¾ç¤º
            if (slotImageMap.size === 0) {
                return;
            }

            // ğŸ”‘ ä¿®å¤ï¼šéå†slotImageMapè€Œä¸æ˜¯uploadedImagesï¼Œé¿å…åŒä¸€slotçš„å›¾ç‰‡é‡å¤æ˜¾ç¤º
            slotImageMap.forEach((imageId, slotKey) => {
                const imageData = uploadedImages.get(imageId);
                if (!imageData) return; // å®‰å…¨æ£€æŸ¥

                const thumbnail = document.createElement('div');
                thumbnail.className = 'relative w-full aspect-square rounded-lg overflow-hidden bg-gray-200 dark:bg-zinc-800';
                thumbnail.innerHTML = `
                    <img src="${imageData.dataUrl}" alt="${imageData.name}" class="w-full h-full object-cover">
                `;
                container.appendChild(thumbnail);
            });

            console.log(`ğŸ” å·²æ›´æ–°æŠ˜å ç¼©ç•¥å›¾: ${slotImageMap.size} å¼ ï¼ˆæŒ‰slotå»é‡ï¼‰`);
        }

        // textareaè¾“å…¥æ—¶ä¸è‡ªåŠ¨å¢é«˜ï¼ˆä¿æŒå›ºå®šé«˜åº¦ï¼‰
        promptInput.addEventListener('input', () => {
            // åªåœ¨å±•å¼€çŠ¶æ€ä¸‹ä¸åšä»»ä½•å¤„ç†ï¼ŒæŠ˜å çŠ¶æ€ä¸‹ä¿æŒå›ºå®šé«˜åº¦
            // ç§»é™¤è‡ªåŠ¨å¢é«˜é€»è¾‘
        });

        // ç‚¹å‡»æŠ˜å æŒ‰é’®
        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSidebar();
        });

        // ç‚¹å‡»ä¾§è¾¹æ ç‰¹å®šç©ºç™½åŒºåŸŸæŠ˜å /å±•å¼€
        sidebar.addEventListener('click', (e) => {
            // åªåœ¨ç‚¹å‡»sidebaræœ¬èº«æˆ–logoåŒºåŸŸæ—¶è§¦å‘ï¼Œç¼©å°èŒƒå›´
            if (e.target === sidebar) {
                toggleSidebar();
            }
        });

        // é˜»æ­¢ç‰¹å®šå…ƒç´ å†’æ³¡ï¼ˆé¿å…ç‚¹å‡»æ—¶è§¦å‘æŠ˜å ï¼‰
        // åªé˜»æ­¢inputå’Œlabelï¼Œä¸é˜»æ­¢æŒ‰é’®ç»„çš„button
        const interactiveElements = sidebar.querySelectorAll('input, label, #add-upload-row-btn, #sidebar-toggle-btn');
        interactiveElements.forEach(el => {
            el.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });

        // 6. å›¾ç‰‡ä¸Šä¼ é¢„è§ˆåŠŸèƒ½
        const uploadedImages = new Map(); // ä½¿ç”¨Mapå­˜å‚¨ï¼Œkeyä¸ºå”¯ä¸€ID
        const slotImageMap = new Map(); // è®°å½•æ¯ä¸ªslotå¯¹åº”çš„å›¾ç‰‡ID
        const labelDefaults = new WeakMap(); // è®°å½•labelé»˜è®¤å†…å®¹
        let imageIdCounter = 0; // å…¨å±€IDè®¡æ•°å™¨

        function cacheLabelDefault(labelElement) {
            if (labelElement && !labelDefaults.has(labelElement)) {
                labelDefaults.set(labelElement, labelElement.innerHTML);
            }
        }

        function resetLabelContent(labelElement) {
            if (!labelElement) return;
            const defaultContent = labelDefaults.get(labelElement);
            if (defaultContent !== undefined) {
                labelElement.innerHTML = defaultContent;
            } else {
                labelElement.innerHTML = '<span class="material-symbols-outlined text-3xl text-black/30">add_photo_alternate</span>';
            }
            delete labelElement.dataset.imageId;
        }

        function getSlotKey(labelElement) {
            return labelElement?.dataset?.slot || '';
        }

        function detachLabelImage(labelElement) {
            if (!labelElement) return;
            const slotKey = getSlotKey(labelElement);

            if (slotKey && slotImageMap.has(slotKey)) {
                const imageId = slotImageMap.get(slotKey);
                uploadedImages.delete(imageId);
                slotImageMap.delete(slotKey);
                document.querySelectorAll(`label[data-slot="${slotKey}"]`).forEach(label => {
                    resetLabelContent(label);
                });
                console.log('å·²åˆ é™¤å›¾ç‰‡ Slot:', slotKey, 'å‰©ä½™:', uploadedImages.size);

                // ğŸ”‘ ä¿®å¤3: æ›´æ–°æŠ˜å æ—¶çš„ç¼©ç•¥å›¾ï¼ˆå¦‚æœä¾§è¾¹æ å½“å‰æ˜¯æŠ˜å çŠ¶æ€ï¼‰
                if (sidebar && sidebar.classList.contains('is-collapsed')) {
                    updateCollapsedThumbnails();
                }
                return;
            }

            const existingId = labelElement.dataset.imageId;
            if (existingId) {
                uploadedImages.delete(existingId);
            }
            resetLabelContent(labelElement);
            console.log('å·²åˆ é™¤å›¾ç‰‡ ID:', existingId, 'å‰©ä½™:', uploadedImages.size);

            // ğŸ”‘ ä¿®å¤3: æ›´æ–°æŠ˜å æ—¶çš„ç¼©ç•¥å›¾ï¼ˆå¦‚æœä¾§è¾¹æ å½“å‰æ˜¯æŠ˜å çŠ¶æ€ï¼‰
            if (sidebar && sidebar.classList.contains('is-collapsed')) {
                updateCollapsedThumbnails();
            }
        }

        // ä¸»ä¸Šä¼ æ¡†
        const mainImageUpload = document.getElementById('main-image-upload');
        const mainImageUploadIcon = document.getElementById('main-image-upload-icon');
        const mainUploadLabel = mainImageUpload.previousElementSibling;
        const mainUploadLabelIcon = mainImageUploadIcon.previousElementSibling;
        [mainUploadLabel, mainUploadLabelIcon].forEach(label => cacheLabelDefault(label));

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        async function handleImageUpload(file, labelElement) {
            // éªŒè¯æ–‡ä»¶
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showError('è¯·ä¸Šä¼  PNGã€JPG æˆ– WebP æ ¼å¼çš„å›¾ç‰‡');
                return;
            }

            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                return;
            }

            // å¦‚æœè¯¥ä¸Šä¼ æ§½å·²æœ‰å›¾ç‰‡ï¼Œå…ˆç§»é™¤æ—§æ•°æ®
            detachLabelImage(labelElement);

            // è¯»å–æ–‡ä»¶ä¸ºBase64
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                const imageId = `img_${imageIdCounter++}`; // ç”Ÿæˆå”¯ä¸€ID
                const slotKey = getSlotKey(labelElement);

                // ä¿å­˜åˆ°Map
                uploadedImages.set(imageId, {
                    file: file,
                    dataUrl: dataUrl,
                    name: file.name
                });

                // æ˜¾ç¤ºé¢„è§ˆ
                showImagePreview(labelElement, dataUrl, imageId);

                if (slotKey) {
                    slotImageMap.set(slotKey, imageId);
                }

                console.log('å·²ä¸Šä¼ å›¾ç‰‡:', file.name, 'ID:', imageId, 'æ€»æ•°:', uploadedImages.size, 'Slot:', slotKey || 'N/A');

                // ğŸ”‘ ä¿®å¤3: æ›´æ–°æŠ˜å æ—¶çš„ç¼©ç•¥å›¾ï¼ˆå¦‚æœä¾§è¾¹æ å½“å‰æ˜¯æŠ˜å çŠ¶æ€ï¼‰
                if (sidebar.classList.contains('is-collapsed')) {
                    updateCollapsedThumbnails();
                }
            };
            reader.readAsDataURL(file);
        }

        function renderPreview(labelElement, dataUrl, imageId) {
            labelElement.innerHTML = '';
            labelElement.dataset.imageId = imageId;

            const preview = document.createElement('div');
            preview.className = 'v2-upload-preview w-full h-full relative';
            preview.style.backgroundImage = `url(${dataUrl})`;
            preview.dataset.imageId = imageId;

            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'v2-upload-delete';
            deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">close</span>';
            deleteBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                detachLabelImage(labelElement);
            });

            preview.appendChild(deleteBtn);
            labelElement.appendChild(preview);

            preview.addEventListener('click', (e) => {
                if (!e.target.classList.contains('v2-upload-delete') && !e.target.closest('.v2-upload-delete')) {
                    console.log('ç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡:', imageId);
                }
            });
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼ˆæ”¯æŒåŒslotçš„å¤šä¸ªlabelåŒæ­¥çŠ¶æ€ï¼‰
        function showImagePreview(labelElement, dataUrl, imageId) {
            const slotKey = getSlotKey(labelElement);
            if (slotKey) {
                const relatedLabels = document.querySelectorAll(`label[data-slot="${slotKey}"]`);
                relatedLabels.forEach(label => {
                    cacheLabelDefault(label);
                    renderPreview(label, dataUrl, imageId);
                });
            } else {
                cacheLabelDefault(labelElement);
                renderPreview(labelElement, dataUrl, imageId);
            }
        }

        // ä¸»ä¸Šä¼ æ¡†äº‹ä»¶
        mainImageUpload.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageUpload(e.target.files[0], mainUploadLabel);
                e.target.value = ''; // æ¸…ç©ºinputä»¥å…è®¸é‡å¤ä¸Šä¼ 
            }
        });

        mainImageUploadIcon.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageUpload(e.target.files[0], mainUploadLabelIcon);
                e.target.value = '';
            }
        });

        // 7. å¼€å…³ç³»åˆ—å›¾ï¼ˆå¢å¼ºï¼šç¦ç”¨å°ºå¯¸/æ•°é‡é€‰æ‹©+é‡ç½®+æç¤ºï¼‰
        const seriesToggle = document.getElementById('series-mode-toggle');
        const aspectRatioGroup = document.getElementById('aspect-ratio-group');
        const imageCountGroup = document.getElementById('image-count-group');

        seriesToggle.addEventListener('click', () => {
            const isChecked = seriesToggle.getAttribute('aria-checked') === 'true';
            const newState = !isChecked;
            seriesToggle.setAttribute('aria-checked', newState);

            if (newState) {
                // åˆ‡æ¢åˆ°ç³»åˆ—å›¾æ¨¡å¼
                console.log('âœ¨ åˆ‡æ¢åˆ°ç³»åˆ—å›¾æ¨¡å¼');

                // 1. é‡ç½®å°ºå¯¸åˆ°1:1
                const ratioButtons = aspectRatioGroup.querySelectorAll('button');
                ratioButtons.forEach(btn => {
                    btn.dataset.active = 'false';
                    btn.classList.remove('bg-black', 'text-white', 'font-semibold', 'ring-2', 'ring-black');
                    btn.classList.add('bg-white/50', 'hover:bg-white/80');

                    if (btn.dataset.ratio === '1:1') {
                        btn.dataset.active = 'true';
                        btn.classList.remove('bg-white/50', 'hover:bg-white/80');
                        btn.classList.add('bg-black', 'text-white', 'font-semibold', 'ring-2', 'ring-black');
                    }
                });

                // 2. é‡ç½®æ•°é‡åˆ°1
                const countButtons = imageCountGroup.querySelectorAll('button');
                countButtons.forEach(btn => {
                    btn.dataset.active = 'false';
                    btn.classList.remove('bg-black', 'text-white', 'font-semibold', 'ring-2', 'ring-black');
                    btn.classList.add('bg-white/50', 'hover:bg-white/80');

                    if (btn.textContent.trim() === '1') {
                        btn.dataset.active = 'true';
                        btn.classList.remove('bg-white/50', 'hover:bg-white/80');
                        btn.classList.add('bg-black', 'text-white', 'font-semibold', 'ring-2', 'ring-black');
                    }
                });

                // 3. ç¦ç”¨å°ºå¯¸å’Œæ•°é‡é€‰æ‹©
                aspectRatioGroup.style.opacity = '0.5';
                aspectRatioGroup.style.pointerEvents = 'none';
                imageCountGroup.style.opacity = '0.5';
                imageCountGroup.style.pointerEvents = 'none';

                // 4. æ˜¾ç¤ºæ¸©å’Œæç¤º
                showInfo('ç³»åˆ—å›¾æ¨¡å¼å·²å¼€å¯ã€‚å°ºå¯¸å’Œæ•°é‡ç”±æ¨¡å‹è‡ªåŠ¨å†³å®šï¼ˆå›ºå®šæ¶ˆè€—2ç²’å­å¸ï¼‰', 4000);

            } else {
                // åˆ‡æ¢å›æ™®é€šæ¨¡å¼
                console.log('âœ¨ åˆ‡æ¢å›æ™®é€šæ¨¡å¼');

                // æ¢å¤å°ºå¯¸å’Œæ•°é‡é€‰æ‹©
                aspectRatioGroup.style.opacity = '1';
                aspectRatioGroup.style.pointerEvents = 'auto';
                imageCountGroup.style.opacity = '1';
                imageCountGroup.style.pointerEvents = 'auto';

                showInfo('å·²åˆ‡æ¢å›æ™®é€šæ¨¡å¼');
            }
        });

        // 7.5. ä»»åŠ¡å¡ç‰‡ä¸‹æ‹‰èœå•å¤„ç†
        let currentOpenMenu = null;

        // ç‚¹å‡»ä»»åŠ¡èœå•æŒ‰é’®
        resultsContainer.addEventListener('click', async (e) => {
            const menuBtn = e.target.closest('.v2-task-menu-btn');
            if (menuBtn) {
                e.stopPropagation();
                const wrapper = menuBtn.closest('.v2-task-menu-wrapper');
                const menu = wrapper.querySelector('.v2-dropdown-menu');

                // å…³é—­å…¶ä»–èœå•
                if (currentOpenMenu && currentOpenMenu !== menu) {
                    currentOpenMenu.classList.remove('active');
                }

                // åˆ‡æ¢å½“å‰èœå•
                menu.classList.toggle('active');
                currentOpenMenu = menu.classList.contains('active') ? menu : null;
                return;
            }

            // ç‚¹å‡»èœå•é¡¹
            const menuItem = e.target.closest('.v2-dropdown-item');
            if (menuItem) {
                const action = menuItem.dataset.action;
                const taskCard = menuItem.closest('.space-y-4');

                if (action === 'regenerate') {
                    // å¤ç”¨æ—§ç‰ˆé€»è¾‘ï¼šå†æ¬¡ç”Ÿæˆ

                    // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
                    if (!window.V2App || !window.V2App.isLoggedIn) {
                        showWarning('è¯·å…ˆç™»å½•');
                        return;
                    }

                    // 2. è·å–å­˜å‚¨çš„åŸå§‹å‚æ•°
                    const originalPrompt = taskCard.dataset.originalPrompt || '';
                    const aspectRatio = taskCard.dataset.aspectRatio || '1:1';
                    const count = parseInt(taskCard.dataset.count) || 1;
                    const seriesMode = taskCard.dataset.seriesMode === 'true';
                    const hasReferenceImages = taskCard.dataset.hasReferenceImages === 'true';
                    const taskId = taskCard.dataset.taskId;

                    // ğŸ” è°ƒè¯•ï¼šè¾“å‡ºdatasetå€¼
                    console.log('ğŸ” é‡æ–°ç”Ÿæˆå‚æ•°:', {
                        taskId,
                        hasReferenceImages,
                        hasReferenceImagesRaw: taskCard.dataset.hasReferenceImages,
                        seriesMode,
                        count,
                        aspectRatio
                    });

                    if (!originalPrompt) {
                        showError('æ— æ³•è·å–åŸå§‹æç¤ºè¯');
                        return;
                    }

                    // 3. æ£€æŸ¥ç²’å­å¸ä½™é¢ï¼ˆå¤ç”¨æ—§ç‰ˆé€»è¾‘ï¼‰
                    const currentUser = window.V2App.currentUser;
                    const requiredParticles = seriesMode ? 2 : count;  // ç³»åˆ—å›¾2å¸ï¼Œæ–‡ç”Ÿå›¾1å¸/å¼ 

                    if (!currentUser || currentUser.particles < requiredParticles) {
                        showWarning(
                            `ç²’å­å¸ä½™é¢ä¸è¶³ã€‚å½“å‰ä½™é¢ï¼š${currentUser?.particles || 0} å¸ï¼Œå†æ¬¡ç”Ÿæˆéœ€è¦ï¼š${requiredParticles} å¸`
                        );
                        return;
                    }

                    // 4. å…³é—­èœå•
                    if (currentOpenMenu) {
                        currentOpenMenu.classList.remove('active');
                        currentOpenMenu = null;
                    }

                    // 5. å¦‚æœæ˜¯å›¾ç”Ÿå›¾æˆ–ç³»åˆ—å›¾æ¨¡å¼ï¼Œéœ€è¦å…ˆåŠ è½½åŸå§‹å‚è€ƒå›¾ç‰‡
                    let regenerateUploadedImages = new Map();

                    if (hasReferenceImages && taskId) {
                        try {
                            showInfo('æ­£åœ¨åŠ è½½åŸå§‹å‚è€ƒå›¾ç‰‡...');
                            console.log('ğŸ”„ åŠ è½½åŸå§‹å‚è€ƒå›¾ç‰‡ from task:', taskId);

                            // ğŸ”‘ å¤ç”¨æ—§ç‰ˆé€»è¾‘ï¼šè°ƒç”¨getTaskDetailè·å–å®Œæ•´æ•°æ®ï¼ˆåŒ…å«reference_imagesï¼‰
                            const taskDetail = await window.V2App.history.getTaskDetail(taskId, null, true);

                            console.log('  ğŸ“¦ ä»»åŠ¡è¯¦æƒ…è¿”å›:', {
                                has_task: !!taskDetail?.task,
                                has_reference_images: !!taskDetail?.task?.reference_images,
                                reference_images_length: taskDetail?.task?.reference_images?.length
                            });

                            if (taskDetail && taskDetail.task && taskDetail.task.reference_images && taskDetail.task.reference_images.length > 0) {
                                const referenceImages = taskDetail.task.reference_images;
                                console.log('  âœ… è·å–åˆ°å‚è€ƒå›¾ç‰‡:', referenceImages.length, 'å¼ ');

                                // ğŸ”‘ è¾…åŠ©å‡½æ•°ï¼šå°†base64 dataUrlè½¬æ¢ä¸ºFileå¯¹è±¡
                                const dataURLtoFile = (dataUrl, filename) => {
                                    const arr = dataUrl.split(',');
                                    const mime = arr[0].match(/:(.*?);/)[1];
                                    const bstr = atob(arr[1]);
                                    let n = bstr.length;
                                    const u8arr = new Uint8Array(n);
                                    while (n--) {
                                        u8arr[n] = bstr.charCodeAt(n);
                                    }
                                    return new File([u8arr], filename, { type: mime });
                                };

                                // å°†reference_imagesï¼ˆbase64æ ¼å¼ï¼‰è½¬æ¢ä¸ºuploadedImages Mapæ ¼å¼
                                for (let index = 0; index < referenceImages.length; index++) {
                                    const dataUrl = referenceImages[index];
                                    const imageId = `regenerate-${Date.now()}-${index}`;
                                    const filename = `reference-image-${index + 1}.png`;

                                    // è½¬æ¢ä¸ºFileå¯¹è±¡
                                    const file = dataURLtoFile(dataUrl, filename);

                                    regenerateUploadedImages.set(imageId, {
                                        file: file,  // âœ… çœŸå®çš„Fileå¯¹è±¡
                                        dataUrl: dataUrl,  // base64æ ¼å¼
                                        name: filename,
                                        slot: `image-upload-${index + 1}`
                                    });
                                }

                                console.log('  âœ… å·²æ¢å¤', regenerateUploadedImages.size, 'å¼ å‚è€ƒå›¾ç‰‡ï¼ˆå·²è½¬æ¢ä¸ºFileå¯¹è±¡ï¼‰');
                            } else {
                                console.warn('  âš ï¸ ä»»åŠ¡è¯¦æƒ…ä¸­æ²¡æœ‰æ‰¾åˆ°reference_imagesï¼Œå¯èƒ½æ˜¯çº¯æ–‡ç”Ÿå›¾æˆ–ç³»åˆ—å›¾');
                            }
                        } catch (error) {
                            console.error('  âŒ åŠ è½½å‚è€ƒå›¾ç‰‡å¤±è´¥:', error);
                            showWarning('æ— æ³•åŠ è½½åŸå§‹å‚è€ƒå›¾ç‰‡ï¼Œå°†ä»¥æ–‡ç”Ÿå›¾æ¨¡å¼é‡æ–°ç”Ÿæˆ');
                        }
                    }

                    // 6. åˆ›å»ºæ–°çš„ä»»åŠ¡å¡ç‰‡ï¼ˆä¸ç”ŸæˆæŒ‰é’®é€»è¾‘ä¸€è‡´ï¼‰
                    const newResultGroup = document.createElement('div');
                    newResultGroup.className = 'space-y-4';
                    newResultGroup.dataset.originalPrompt = originalPrompt;
                    newResultGroup.dataset.aspectRatio = aspectRatio;
                    newResultGroup.dataset.count = count;
                    newResultGroup.dataset.seriesMode = seriesMode;
                    newResultGroup.dataset.hasReferenceImages = (regenerateUploadedImages.size > 0) ? 'true' : 'false';

                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center';
                    header.innerHTML = `
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            ${originalPrompt.substring(0, 40)}${originalPrompt.length > 40 ? '...' : ''}
                        </p>
                        <div class="relative v2-task-menu-wrapper">
                            <button class="v2-task-menu-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                                <span class="material-symbols-outlined text-base">more_horiz</span>
                            </button>
                            <div class="v2-dropdown-menu">
                                <div class="v2-dropdown-item" data-action="regenerate" title="é‡æ–°ç”Ÿæˆ">
                                    <span class="material-symbols-outlined">refresh</span>
                                </div>
                                <div class="v2-dropdown-item" data-action="copy" title="å¤åˆ¶æç¤ºè¯">
                                    <span class="material-symbols-outlined">content_copy</span>
                                </div>
                                <div class="v2-dropdown-item" data-action="delete" title="åˆ é™¤ä»»åŠ¡">
                                    <span class="material-symbols-outlined">delete</span>
                                </div>
                            </div>
                        </div>
                    `;

                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';

                    // æ˜¾ç¤ºåŠ è½½å ä½ç¬¦
                    for (let i = 0; i < count; i++) {
                        const loadingPlaceholder = document.createElement('div');
                        loadingPlaceholder.className = 'v2-image-wrapper w-full rounded-lg bg-gray-200 dark:bg-zinc-800 animate-pulse flex items-center justify-center';
                        loadingPlaceholder.setAttribute('data-aspect', aspectRatio);
                        loadingPlaceholder.innerHTML = '<span class="material-symbols-outlined text-4xl text-gray-400">image</span>';
                        grid.appendChild(loadingPlaceholder);
                    }

                    newResultGroup.appendChild(header);
                    newResultGroup.appendChild(grid);

                    // æ’å…¥åˆ°ç»“æœå®¹å™¨é¡¶éƒ¨
                    const resultsContainer = document.getElementById('results-container');
                    resultsContainer.insertBefore(newResultGroup, resultsContainer.firstChild);

                    // ğŸ”‘ ä¿®å¤ï¼šä¸æ»‘æ»šåŠ¨åˆ°æ–°åˆ›å»ºçš„ä»»åŠ¡ï¼Œç»™ç”¨æˆ·åé¦ˆ
                    setTimeout(() => {
                        newResultGroup.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);

                    // 7. è°ƒç”¨ç”ŸæˆAPIï¼ˆä¸ç”ŸæˆæŒ‰é’®é€»è¾‘ä¸€è‡´ï¼‰
                    (async () => {
                        try {
                            console.log('ğŸ”„ å†æ¬¡ç”Ÿæˆ...', {
                                prompt: originalPrompt,
                                count: count,
                                aspectRatio: aspectRatio,
                                seriesMode: seriesMode,
                                hasReferenceImages: regenerateUploadedImages.size > 0,
                                referenceImagesCount: regenerateUploadedImages.size
                            });

                            const result = await window.V2App.handleGenerate({
                                prompt: originalPrompt,
                                uploadedImages: regenerateUploadedImages,  // âœ… ä¼ å…¥æ¢å¤çš„å‚è€ƒå›¾ç‰‡
                                count: count,
                                aspectRatio: aspectRatio,
                                seriesMode: seriesMode,
                                onProgress: (progress) => {
                                    // ğŸ”‘ ä¿®å¤ç³»åˆ—å›¾æ¸²æŸ“ï¼šåŒæ—¶å¤„ç† 'processing' å’Œ 'completed' çŠ¶æ€
                                    if ((progress.status === 'processing' || progress.status === 'completed') && progress.images && progress.images.length > 0) {
                                        grid.innerHTML = '';

                                        progress.images.forEach((imageData, index) => {
                                            const imageWrapper = document.createElement('div');
                                            imageWrapper.className = 'v2-image-wrapper relative group w-full rounded-xl flex-shrink-0 overflow-hidden bg-gray-100';
                                            imageWrapper.setAttribute('data-aspect', aspectRatio);

                                            const img = document.createElement('img');
                                            img.src = imageData.url || imageData.thumbnail_url;
                                            img.alt = `ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}`;
                                            img.className = 'w-full h-full object-cover';

                                            const overlay = document.createElement('div');
                                            overlay.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center gap-4 opacity-0 group-hover:opacity-100';
                                            overlay.innerHTML = `
                                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                                    data-action="view"
                                                    onclick="openImageViewer('${imageData.url || imageData.thumbnail_url}')">
                                                    visibility
                                                </span>
                                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                                    data-action="edit"
                                                    onclick="showInfo('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­')">
                                                    edit
                                                </span>
                                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                                    data-action="video"
                                                    onclick="showInfo('è§†é¢‘åŠŸèƒ½å¼€å‘ä¸­')">
                                                    movie
                                                </span>
                                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                                    data-action="favorite"
                                                    onclick="showInfo('æ”¶è—åŠŸèƒ½å¼€å‘ä¸­')">
                                                    favorite
                                                </span>
                                                <span class="material-symbols-outlined text-white text-2xl cursor-pointer hover:scale-125 transition-transform"
                                                    data-action="download"
                                                    onclick="window.location.href='${imageData.url || imageData.thumbnail_url}'">
                                                    download
                                                </span>
                                            `;

                                            imageWrapper.appendChild(img);
                                            imageWrapper.appendChild(overlay);
                                            grid.appendChild(imageWrapper);
                                        });

                                        const remainingCount = progress.total - progress.images.length;
                                        for (let i = 0; i < remainingCount; i++) {
                                            const loadingPlaceholder = document.createElement('div');
                                            loadingPlaceholder.className = 'v2-image-wrapper w-full rounded-lg bg-gray-200 dark:bg-zinc-800 animate-pulse flex items-center justify-center';
                                            loadingPlaceholder.setAttribute('data-aspect', aspectRatio);
                                            loadingPlaceholder.innerHTML = '<span class="material-symbols-outlined text-4xl text-gray-400">image</span>';
                                            grid.appendChild(loadingPlaceholder);
                                        }
                                    }
                                }
                            });

                            console.log('ğŸ“¦ å†æ¬¡ç”Ÿæˆè¿”å›æ•°æ®:', result);

                            if (result.success && result.data && result.data.images && result.data.images.length > 0) {
                                // ğŸ”‘ ä¿å­˜task_idåˆ°datasetï¼Œç”¨äºåˆ é™¤æ“ä½œ
                                if (result.data.task_id) {
                                    newResultGroup.dataset.taskId = result.data.task_id;
                                }

                                const successCount = result.data.success_count || result.data.images.length;
                                const failedCount = result.data.failed_count || 0;

                                if (failedCount > 0) {
                                    showWarning(`ç”Ÿæˆå®Œæˆï¼šæˆåŠŸ ${successCount} å¼ ï¼Œå¤±è´¥ ${failedCount} å¼ `);
                                } else {
                                    showSuccess(`æˆåŠŸç”Ÿæˆ ${successCount} å¼ å›¾ç‰‡ï¼`);
                                }
                            } else {
                                console.error('âŒ å†æ¬¡ç”Ÿæˆå¤±è´¥ï¼Œæ•°æ®ç»“æ„:', result);
                                grid.innerHTML = `
                                    <div class="col-span-full text-center text-red-500 p-4">
                                        ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•
                                    </div>
                                `;
                                showError(result.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                            }
                        } catch (error) {
                            console.error('âŒ å†æ¬¡ç”Ÿæˆå¼‚å¸¸:', error);
                            grid.innerHTML = `
                                <div class="col-span-full text-center text-red-500 p-4">
                                    ${error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•'}
                                </div>
                            `;
                            showError(error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    })();

                    return;  // æå‰è¿”å›ï¼Œé¿å…ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘
                } else if (action === 'copy') {
                    // ä½¿ç”¨å­˜å‚¨çš„åŸå§‹æç¤ºè¯ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºæ–‡æœ¬ï¼ˆå¯èƒ½åŒ…å«çŠ¶æ€ä¿¡æ¯ï¼‰
                    const originalPrompt = taskCard.dataset.originalPrompt || '';
                    navigator.clipboard.writeText(originalPrompt).then(() => {
                        showSuccess('æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    });
                } else if (action === 'delete') {
                    // å¤ç”¨æ—§ç‰ˆé€»è¾‘ï¼šåˆ é™¤ä»»åŠ¡
                    const confirmed = await window.v2Confirm.show('ç¡®å®šåˆ é™¤æ­¤è®°å½•å—ï¼Ÿ', {
                        type: 'danger',
                        okText: 'åˆ é™¤',
                        cancelText: 'å–æ¶ˆ'
                    });
                    if (!confirmed) return;

                    const taskId = taskCard.dataset.taskId;

                    // å¦‚æœæœ‰task_idï¼Œè°ƒç”¨åç«¯APIåˆ é™¤
                    if (taskId) {
                        (async () => {
                            try {
                                await window.V2App.history.deleteTask(taskId);
                                taskCard.remove();
                                showSuccess('åˆ é™¤æˆåŠŸ');
                            } catch (error) {
                                console.error('[åˆ é™¤ä»»åŠ¡] å¤±è´¥:', error);
                                showError('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                            }
                        })();
                    } else {
                        // æ²¡æœ‰task_idï¼Œè¯´æ˜æ˜¯æœ¬åœ°æœªä¿å­˜çš„ä»»åŠ¡ï¼Œç›´æ¥åˆ é™¤DOM
                        taskCard.remove();
                        showSuccess('å·²åˆ é™¤');
                    }
                }

                // å…³é—­èœå•
                if (currentOpenMenu) {
                    currentOpenMenu.classList.remove('active');
                    currentOpenMenu = null;
                }
            }
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', () => {
            if (currentOpenMenu) {
                currentOpenMenu.classList.remove('active');
                currentOpenMenu = null;
            }
        });

        // 8. ä¸ºæœªå®ç°åŠŸèƒ½çš„æŒ‰é’®æ·»åŠ å ä½æç¤º
        // æ³¨æ„ï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®

        // é¡¶éƒ¨headeræŒ‰é’®ï¼ˆè§†é¢‘ã€æ”¶è—ï¼‰
        document.querySelector('header').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;

            const icon = btn.querySelector('.material-symbols-outlined');
            if (!icon) return;

            const iconText = icon.textContent.trim();
            if (iconText === 'movie') {
                showComingSoon('è§†é¢‘ç®¡ç†');
            } else if (iconText === 'favorite') {
                showComingSoon('æ”¶è—ç®¡ç†');
            }
        });

        // åº•éƒ¨è¾“å…¥æ¡†å³ä¾§æŒ‰é’®ï¼ˆmic/image/settings/AIä¼˜åŒ–ï¼‰
        const promptInputArea = document.querySelector('#prompt-wrapper');
        promptInputArea.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn || btn.id === 'generate-btn-bottom') return; // æ’é™¤ç”ŸæˆæŒ‰é’®

            const icon = btn.querySelector('.material-symbols-outlined');
            if (!icon) return;

            const iconText = icon.textContent.trim();
            if (iconText === 'mic') {
                showComingSoon('è¯­éŸ³è¾“å…¥');
            } else if (iconText === 'image') {
                showComingSoon('å›¾ç‰‡è¯†åˆ«æç¤ºè¯');
            } else if (iconText === 'settings') {
                showComingSoon('é«˜çº§è®¾ç½®');
            } else if (iconText === 'auto_awesome') {
                // AIæç¤ºè¯ä¼˜åŒ–
                handleOptimizePrompt();
            }
        });

        // ç»“æœå®¹å™¨ä¸­çš„åŠ¨æ€æŒ‰é’®ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
        // overlayä¸­çš„å›¾æ ‡æŒ‰é’®å ä½æç¤º
        document.addEventListener('click', (e) => {
            const icon = e.target.closest('.material-symbols-outlined');

            // overlayä¸­çš„å›¾æ ‡æŒ‰é’®
            if (icon && icon.closest('[class*="opacity-0"]')) {
                const iconText = icon.textContent.trim();
                if (iconText === 'edit') {
                    showComingSoon('ç¼–è¾‘å›¾ç‰‡');
                } else if (iconText === 'movie') {
                    showComingSoon('è½¬è§†é¢‘');
                } else if (iconText === 'favorite') {
                    showComingSoon('æ”¶è—å›¾ç‰‡');
                } else if (iconText === 'download') {
                    showComingSoon('ä¸‹è½½å›¾ç‰‡');
                }
            }
        });

        // --- è®¤è¯å¼¹çª—é€»è¾‘ï¼ˆå®Œå…¨å¤ç”¨æ—§ç‰ˆå®ç°ï¼‰ ---
        const authModal = document.getElementById('v2AuthModal');
        const authCloseBtn = document.getElementById('v2AuthCloseBtn');
        const authError = document.getElementById('v2AuthError');
        const userAvatarBtn = document.querySelector('[data-role="user-avatar"]');

        const authTabs = document.querySelectorAll('.v2-auth-tab');
        const loginForm = document.getElementById('v2LoginForm');
        const registerForm = document.getElementById('v2RegisterForm');

        // æ‰“å¼€å¼¹çª—
        function openAuthModal() {
            authModal.classList.add('active');
            hideAuthError();
        }

        // å…³é—­å¼¹çª—
        function closeAuthModal() {
            authModal.classList.remove('active');
            loginForm.reset();
            registerForm.reset();
            hideAuthError();
        }

        // Tabåˆ‡æ¢
        function switchAuthTab(tab) {
            authTabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.v2-auth-tab[data-tab="${tab}"]`).classList.add('active');

            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
            hideAuthError();
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showAuthError(message) {
            authError.style.background = 'rgba(237, 66, 69, 0.1)';
            authError.style.color = '#ef4444';
            authError.textContent = message;
            authError.classList.add('active');
        }

        // æ˜¾ç¤ºæˆåŠŸ
        function showAuthSuccess(message) {
            authError.style.background = 'rgba(59, 165, 93, 0.1)';
            authError.style.color = '#10b981';
            authError.textContent = message;
            authError.classList.add('active');
        }

        // éšè—æç¤º
        function hideAuthError() {
            authError.style.background = '';
            authError.style.color = '';
            authError.classList.remove('active');
        }

        // è®¾ç½®è¡¨å•åŠ è½½çŠ¶æ€
        function setFormLoading(form, isLoading, text = 'å¤„ç†ä¸­â€¦') {
            const btn = form.querySelector('button[type="submit"]');
            if (!btn) return;

            if (isLoading) {
                btn.dataset.originalText = btn.textContent;
                btn.disabled = true;
                btn.classList.add('loading');
                btn.textContent = text;
            } else {
                btn.disabled = false;
                btn.classList.remove('loading');
                if (btn.dataset.originalText) {
                    btn.textContent = btn.dataset.originalText;
                    delete btn.dataset.originalText;
                }
            }
        }

        // ç”¨æˆ·å¤´åƒç‚¹å‡»äº‹ä»¶
        if (userAvatarBtn) {
            userAvatarBtn.addEventListener('click', async () => {
                if (window.V2App && window.V2App.isLoggedIn) {
                    const confirmed = await window.v2Confirm.show('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', {
                        type: 'warning',
                        okText: 'é€€å‡º',
                        cancelText: 'å–æ¶ˆ'
                    });
                    if (confirmed) {
                        window.V2App.handleLogout();
                    }
                } else {
                    openAuthModal();
                }
            });
        }

        // å…³é—­æŒ‰é’®
        if (authCloseBtn) {
            authCloseBtn.addEventListener('click', closeAuthModal);
        }

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                closeAuthModal();
            }
        });

        // Tabåˆ‡æ¢äº‹ä»¶
        authTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                switchAuthTab(tab.dataset.tab);
            });
        });

        // ç™»å½•è¡¨å•æäº¤
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('v2LoginUsername').value.trim();
            const password = document.getElementById('v2LoginPassword').value.trim();

            if (!username || !password) {
                showAuthError('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            try {
                hideAuthError();
                setFormLoading(loginForm, true, 'ç™»å½•ä¸­â€¦');

                const result = await window.V2App.handleLogin(username, password);

                if (result.success) {
                    showAuthSuccess('ç™»å½•æˆåŠŸï¼');
                    setTimeout(() => {
                        closeAuthModal();
                        window.location.reload();
                    }, 500);
                } else {
                    showAuthError(result.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showAuthError('ç™»å½•å¤±è´¥ï¼Œç½‘ç»œå¯èƒ½ä¸ç¨³å®šï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                setFormLoading(loginForm, false);
            }
        });

        // æ³¨å†Œè¡¨å•æäº¤
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('v2RegisterUsername').value.trim();
            const email = document.getElementById('v2RegisterEmail').value.trim();
            const password = document.getElementById('v2RegisterPassword').value.trim();
            const passwordConfirm = document.getElementById('v2RegisterPasswordConfirm').value.trim();

            // éªŒè¯
            if (username.length < 3) {
                showAuthError('ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦');
                return;
            }

            if (password.length < 6) {
                showAuthError('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
                return;
            }

            if (password !== passwordConfirm) {
                showAuthError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }

            try {
                hideAuthError();
                setFormLoading(registerForm, true, 'æ³¨å†Œä¸­â€¦');

                const result = await window.V2App.handleRegister(username, password, email || null);

                if (result.success) {
                    showAuthSuccess('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è‡ªåŠ¨ç™»å½•...');

                    // è‡ªåŠ¨ç™»å½•
                    setTimeout(async () => {
                        const loginResult = await window.V2App.handleLogin(username, password);
                        if (loginResult.success) {
                            closeAuthModal();
                            window.location.reload();
                        } else {
                            showAuthError('è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œè¯·ç¨ååœ¨ç™»å½•é¡µæ‰‹åŠ¨ç™»å½•');
                            setTimeout(() => {
                                switchAuthTab('login');
                            }, 1500);
                        }
                    }, 1000);
                } else {
                    showAuthError(result.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showAuthError('æ³¨å†Œå¤±è´¥ï¼Œç½‘ç»œå¯èƒ½ä¸ç¨³å®šï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                setFormLoading(registerForm, false);
            }
        });

    });
</script>

</body></html>
